<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêµ Áå¥Â≠©ÂÑøÁ§æ‰∫§Áâà | Monkey Social</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    input::placeholder { color: rgba(255,255,255,0.4); }
    input:focus { outline: none; border-color: #fbbf24 !important; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.6; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAt4tlxNegaodi5c4SfHdR7WcZEcWZ5dxI",
      authDomain: "monkey-social-250aa.firebaseapp.com",
      databaseURL: "https://monkey-social-250aa-default-rtdb.firebaseio.com",
      projectId: "monkey-social-250aa",
      storageBucket: "monkey-social-250aa.firebasestorage.app",
      messagingSenderId: "296405488554",
      appId: "1:296405488554:web:7cc767546c7fb5d4b191d3"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ============================================
    // FIREBASE STORAGE
    // ============================================
    
    const storage = {
      // Save monkey to Firebase
      async saveMonkey(monkey) {
        try {
          await db.ref(`monkeys/${monkey.odId}`).set({
            ...monkey,
            lastActive: Date.now()
          });
          localStorage.setItem('my-monkey-id', monkey.odId);
          return true;
        } catch (e) {
          console.error('Save monkey error:', e);
          return false;
        }
      },
      
      // Get single monkey
      async getMonkey(odId) {
        try {
          const snapshot = await db.ref(`monkeys/${odId}`).once('value');
          return snapshot.val();
        } catch (e) {
          console.error('Get monkey error:', e);
          return null;
        }
      },
      
      // Subscribe to all monkeys (realtime)
      subscribeToMonkeys(callback) {
        const ref = db.ref('monkeys');
        ref.on('value', (snapshot) => {
          const data = snapshot.val() || {};
          callback(Object.values(data));
        });
        return () => ref.off('value');
      },
      
      // Save relation
      async saveRelation(myOdId, friendOdId, relation) {
        try {
          await db.ref(`relations/${myOdId}/${friendOdId}`).set(relation);
          return true;
        } catch (e) {
          console.error('Save relation error:', e);
          return false;
        }
      },
      
      // Get all relations for a monkey
      async getRelations(myOdId) {
        try {
          const snapshot = await db.ref(`relations/${myOdId}`).once('value');
          const data = snapshot.val() || {};
          return Object.values(data);
        } catch (e) {
          return [];
        }
      },
      
      // Save notification
      async saveNotification(targetOdId, notification) {
        try {
          const newRef = db.ref(`notifications/${targetOdId}`).push();
          await newRef.set({ ...notification, id: newRef.key, timestamp: Date.now() });
          return true;
        } catch (e) {
          console.error('Save notification error:', e);
          return false;
        }
      },
      
      // Subscribe to notifications (realtime)
      subscribeToNotifications(odId, callback) {
        const ref = db.ref(`notifications/${odId}`);
        ref.on('value', (snapshot) => {
          const data = snapshot.val() || {};
          callback(Object.values(data));
        });
        return () => ref.off('value');
      },
      
      // Delete notification
      async deleteNotification(odId, notifId) {
        try {
          await db.ref(`notifications/${odId}/${notifId}`).remove();
          return true;
        } catch (e) {
          return false;
        }
      },
      
      getMyMonkeyId() {
        return localStorage.getItem('my-monkey-id');
      }
    };

    // ============================================
    // PSEUDO-AGENT SYSTEM
    // ============================================

    function calculateOfflineEffects(monkey) {
      const now = Date.now();
      const lastVisit = monkey.lastVisitTime || now;
      const hoursAway = (now - lastVisit) / 3600000;
      const hour = new Date().getHours();
      
      // Initialize mood if not exists
      const mood = monkey.mood || { happiness: 70, loneliness: 20, energy: 80 };
      const effects = { moodChanges: {}, events: [], greeting: null };
      
      // Time-based greeting
      let timeGreeting = '';
      if (hour >= 6 && hour < 9) {
        timeGreeting = 'Êó©‰∏äÂ•ΩÔºÅ‚òÄÔ∏è';
      } else if (hour >= 12 && hour < 14) {
        timeGreeting = 'ÂçàÈ•≠Êó∂Èó¥Âï¶~üçå';
      } else if (hour >= 18 && hour < 20) {
        timeGreeting = 'Êôö‰∏äÂ•ΩÂëÄ~üåô';
      } else if (hour >= 22 || hour < 6) {
        timeGreeting = 'Ëøô‰πàÊôö‰∫Ü‰Ω†ËøòÊ≤°Áù°ÂëÄÔºüÔºàÊèâÁúºÁùõÔºâ';
      }

      // Skip if just visited
      if (hoursAway < 0.5) {
        return { ...effects, greeting: null };
      }

      // Generate effects based on time away
      if (hoursAway < 3) {
        effects.greeting = {
          type: 'short',
          hoursAway,
          timeGreeting,
        };
      } else if (hoursAway < 12) {
        effects.moodChanges.loneliness = 5;
        effects.events.push(randomOfflineEvent(monkey, 'short'));
        effects.greeting = {
          type: 'medium',
          hoursAway,
          timeGreeting,
        };
      } else if (hoursAway < 48) {
        effects.moodChanges.loneliness = 15;
        effects.moodChanges.happiness = -5;
        effects.events.push(randomOfflineEvent(monkey, 'medium'));
        effects.events.push(randomOfflineEvent(monkey, 'short'));
        effects.greeting = {
          type: 'long',
          hoursAway,
          timeGreeting,
        };
      } else {
        effects.moodChanges.loneliness = 30;
        effects.moodChanges.happiness = -15;
        effects.moodChanges.security = -5;
        effects.events.push(randomOfflineEvent(monkey, 'long'));
        effects.events.push(randomOfflineEvent(monkey, 'medium'));
        effects.greeting = {
          type: 'verylong',
          hoursAway,
          timeGreeting,
        };
      }

      return effects;
    }

    function randomOfflineEvent(monkey, length) {
      const friendName = monkey.friends?.[0]?.name || '‰∏ÄÂè™Ëù¥Ëù∂';
      
      const shortEvents = [
        'ÂàöÊâçÂú®Ê†ë‰∏äÂèëÂëÜ',
        'ËøΩ‰∫Ü‰∏ÄÂè™Ëù¥Ëù∂',
        'ÂêÉ‰∫Ü‰∏ÄÊ†πÈ¶ôËïâ',
        'ÁªÉ‰π†ÁøªË∑üÂ§¥',
        'Âú®ËçâÂú∞‰∏äÊâìÊªö',
      ];
      
      const mediumEvents = [
        `Âíå${friendName}Áé©‰∫Ü‰∏Ä‰ºöÂÑø`,
        'Â≠¶‰ºö‰∫Ü‰∏Ä‰∏™Êñ∞Âä®‰Ωú',
        'ÂÅö‰∫Ü‰∏Ä‰∏™Â•áÊÄ™ÁöÑÊ¢¶',
        'ÂèëÁé∞‰∫Ü‰∏Ä‰∏™ÁßòÂØÜÂü∫Âú∞',
        'ÁúãÂà∞‰∫Ü‰∏ÄÈÅìÂΩ©Ëôπ',
      ];
      
      const longEvents = [
        'ÊÉ≥‰Ω†ÊÉ≥‰∫ÜÂ•Ω‰πÖÂ•Ω‰πÖ',
        'Áîª‰∫Ü‰∏ÄÂπÖÁîªÁªô‰Ω†Ôºà‰ΩÜÊòØÁîªÂùè‰∫ÜÔºâ',
        '‰∏Ä‰∏™‰∫∫Ë∫≤Âú®Ê†ëÊ¥ûÈáå',
        'Â∑ÆÁÇπËø∑Ë∑Ø‰∫Ü',
        '‰∫§‰∫Ü‰∏Ä‰∏™Êñ∞ÊúãÂèã‰ΩÜÊòØÂæàÊÉ≥‰Ω†',
      ];

      const events = length === 'short' ? shortEvents : length === 'medium' ? mediumEvents : longEvents;
      return events[Math.floor(Math.random() * events.length)];
    }

    async function generateWelcomeMessage(monkey, effects) {
      const { type, hoursAway, timeGreeting } = effects.greeting;
      const traits = monkey.traits || {};
      
      // Personality modifiers
      const isSecure = traits.security > 60;
      const isAnxious = traits.security < 40;
      const isIndependent = traits.independence > 60;
      const isSocial = traits.socialSkill > 60;

      // Build prompt based on personality
      const personalityHints = [];
      if (isAnxious) personalityHints.push('ÂÆπÊòìÁÑ¶Ëôë„ÄÅÂÆ≥ÊÄïË¢´ÊäõÂºÉ');
      if (isSecure) personalityHints.push('ÊúâÂÆâÂÖ®ÊÑü„ÄÅÊÉÖÁª™Á®≥ÂÆö');
      if (isIndependent) personalityHints.push('Áã¨Á´ã„ÄÅ‰∏çÂ§™Èªè‰∫∫');
      if (isSocial) personalityHints.push('Â§ñÂêë„ÄÅÂñúÊ¨¢ËÅäÂ§©');

      const prompt = `‰Ω†ÊòØ‰∏ÄÂè™Âè´"${monkey.name}"ÁöÑÂ∞èÁå¥Â≠êÔºåÊÄßÊ†ºÊòØÔºö${monkey.personality || 'ÂèØÁà±'}„ÄÇ
${personalityHints.length > 0 ? `ÊÄßÊ†ºÁâπÁÇπÔºö${personalityHints.join('„ÄÅ')}` : ''}

‰∏ª‰∫∫Á¶ªÂºÄ‰∫Ü ${Math.round(hoursAway)} Â∞èÊó∂ÔºåÁé∞Âú®ÂõûÊù•‰∫Ü„ÄÇ
‰Ω†Âú®ËøôÊÆµÊó∂Èó¥ÈáåÔºö${effects.events.join('„ÄÅ') || 'Á≠â‰∏ª‰∫∫ÂõûÊù•'}

Áî®1-2Âè•ËØùË∑ü‰∏ª‰∫∫ÊâìÊãõÂëºÔºåË¶ÅÔºö
1. Á¨¶Âêà‰Ω†ÁöÑÊÄßÊ†º
2. ‰ΩìÁé∞‰Ω†Á¶ªÂºÄËøôÊÆµÊó∂Èó¥ÁöÑÊÑüÂèó
3. ÂèØ‰ª•ÊèêÂà∞‰Ω†ÂÅöÁöÑ‰∫ã
4. Âä†‰∏äÂèØÁà±ÁöÑËØ≠Ê∞îËØçÂíåÂä®‰ΩúÊèèÂÜôÂ¶ÇÔºàË∑ëËøáÊù•Ôºâ„ÄÅÔºàÁúºÁùõ‰∫Æ‰∫ÜÔºâ

${timeGreeting ? `Áé∞Âú®ÊòØ${timeGreeting.replace(/[^\u4e00-\u9fa5]/g, '')}ÔºåÂèØ‰ª•ÊèêÂà∞` : ''}

Âè™ËøîÂõûÁå¥Â≠êËØ¥ÁöÑËØùÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ`;

      try {
        const result = await callClaude([{ role: 'user', content: prompt }], 150);
        return result || getFallbackGreeting(type, monkey.name, isAnxious);
      } catch {
        return getFallbackGreeting(type, monkey.name, isAnxious);
      }
    }

    function getFallbackGreeting(type, name, isAnxious) {
      if (type === 'short') {
        return 'ÔºàÁúãÂà∞‰Ω†ÂõûÊù•ÔºåÂºÄÂøÉÂú∞Êå•Êå•ÊâãÔºâ‰Ω†Êù•Âï¶~';
      } else if (type === 'medium') {
        return isAnxious 
          ? 'ÔºàË∑ëËøáÊù•Ôºâ‰Ω†ÂéªÂì™‰∫ÜÂëÄÔºüÊàëÊúâÁÇπÊãÖÂøÉ‰Ω†...'
          : 'Ôºà‰ªéÊ†ë‰∏äË∑≥‰∏ãÊù•Ôºâ‰Ω†ÂõûÊù•Âï¶ÔºÅÊàëÂàöÊâçÂú®Áé©~';
      } else if (type === 'long') {
        return isAnxious
          ? 'ÔºàÁúºÁú∂Á∫¢Á∫¢Âú∞Ë∑ëËøáÊù•Êä±‰Ωè‰Ω†Ôºâ‰Ω†Áªà‰∫éÂõûÊù•‰∫Ü...ÊàëÂ•ΩÊÉ≥‰Ω†...'
          : 'ÔºàÂºÄÂøÉÂú∞Ëπ¶ËøáÊù•Ôºâ‰Ω†ÂèØÁÆóÂõûÊù•‰∫ÜÔºÅÊàëÊúâÂ•ΩÂ§ö‰∫ãÊÉ≥ÂëäËØâ‰Ω†ÔºÅ';
      } else {
        return isAnxious
          ? '...‰Ω†ËøòËÆ∞ÂæóÊàëÂêóÔºüÔºàÂ∞èÂ£∞ÔºâÊàë‰ª•‰∏∫‰Ω†‰∏çË¶ÅÊàë‰∫Ü...'
          : 'ÔºàÊÑ£‰∫Ü‰∏Ä‰∏ãÔºåÁÑ∂ÂêéË∑ëËøáÊù•Ôºâ‰Ω†ÂéªÂì™‰∫ÜÔºÅÊàëÁ≠â‰∫ÜÂ•Ω‰πÖÂ•Ω‰πÖÔºÅ';
      }
    }

    // ============================================
    // CONSTANTS
    // ============================================

    const generateId = () => Math.random().toString(36).substring(2, 15);

    const INITIAL_TRAITS = {
      security: 50, trust: 50, selfWorth: 50, independence: 50,
      resilience: 50, empathy: 50, socialSkill: 50, adventureSpirit: 50,
    };

    const TRAIT_NAMES = {
      security: { zh: 'ÂÆâÂÖ®ÊÑü', en: 'Security' },
      trust: { zh: '‰ø°‰ªª', en: 'Trust' },
      selfWorth: { zh: 'Ëá™Êàë‰ª∑ÂÄº', en: 'Self-Worth' },
      independence: { zh: 'Áã¨Á´ãÊÄß', en: 'Independence' },
      resilience: { zh: 'ÈüßÊÄß', en: 'Resilience' },
      empathy: { zh: 'ÂêåÁêÜÂøÉ', en: 'Empathy' },
      socialSkill: { zh: 'Á§æ‰∫§Âäõ', en: 'Social' },
      adventureSpirit: { zh: 'ÂÜíÈô©', en: 'Adventure' },
    };

    const RELATION_LEVELS = ['ÈôåÁîü', 'ÁÇπÂ§¥‰πã‰∫§', 'Áé©‰º¥', 'ÊúãÂèã', 'Â•ΩÊúãÂèã'];

    const INTERACTION_TYPES = [
      { id: 'greet', zh: 'üëã ÊâìÊãõÂëº', en: 'üëã Say Hi', minRelation: 0 },
      { id: 'play', zh: 'üéÆ ‰∏ÄËµ∑Áé©', en: 'üéÆ Play Together', minRelation: 1 },
      { id: 'gift', zh: 'üéÅ ÈÄÅÁ§ºÁâ©', en: 'üéÅ Give Gift', minRelation: 2 },
      { id: 'share', zh: 'ü§´ ÂàÜ‰∫´ÁßòÂØÜ', en: 'ü§´ Share Secret', minRelation: 3 },
      { id: 'compete', zh: 'üí™ ÊØîËµõ', en: 'üí™ Compete', minRelation: 1 },
    ];

    // ============================================
    // AI FUNCTIONS
    // ============================================

    async function callClaude(messages, maxTokens = 500) {
      try {
        const response = await fetch('https://purple-band-0824.yukonlee2.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: maxTokens,
            messages,
          }),
        });
        const data = await response.json();
        return data.content?.[0]?.text || '';
      } catch (e) {
        console.error('Claude API error:', e);
        return '';
      }
    }

    async function generatePersonality(traits) {
      const prompt = `Ê†πÊçÆ‰ª•‰∏ãÊÄßÊ†ºÊï∞ÂÄºÔºåÁî®8‰∏™Â≠ó‰ª•ÂÜÖÊèèËø∞ËøôÂè™Â∞èÁå¥Â≠êÁöÑÊÄßÊ†ºÔºö
${Object.entries(traits).map(([k, v]) => `${TRAIT_NAMES[k]?.zh}:${v}`).join(', ')}
Âè™ËøîÂõûÊÄßÊ†ºÊèèËø∞ÔºåÂ¶Ç"Ê¥ªÊ≥ºÂ§ñÂêëÔºåÊúâÁÇπÂÜíÂ§±"`;
      
      const result = await callClaude([{ role: 'user', content: prompt }], 50);
      return result || 'ÂèØÁà±ÁöÑÂ∞èÁå¥Â≠ê';
    }

    async function generateSocialInteraction(monkey1, monkey2, interactionType, existingRelation) {
      const relationLevel = existingRelation?.level || 0;
      const relationName = RELATION_LEVELS[relationLevel];
      const sharedMemories = existingRelation?.sharedMemories || [];

      const prompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÂÑøÁ´•Á§æ‰∫§Ê®°ÊãüÂô®„ÄÇÊ®°Êãü‰∏§Âè™Â∞èÁå¥Â≠êÁöÑ‰∫íÂä®„ÄÇ

Â∞èÁå¥Â≠êA: ${monkey1.name} (${monkey1.ownerName}ÁöÑ)
- ÊÄßÊ†º: ${monkey1.personality || 'Êú™Áü•'}
- ÁâπË¥®: ${Object.entries(monkey1.traits).map(([k,v]) => `${TRAIT_NAMES[k]?.zh}:${v}`).join(', ')}

Â∞èÁå¥Â≠êB: ${monkey2.name} (${monkey2.ownerName}ÁöÑ)
- ÊÄßÊ†º: ${monkey2.personality || 'Êú™Áü•'}
- ÁâπË¥®: ${Object.entries(monkey2.traits).map(([k,v]) => `${TRAIT_NAMES[k]?.zh}:${v}`).join(', ')}

ÂΩìÂâçÂÖ≥Á≥ª: ${relationName}
${sharedMemories.length > 0 ? `ÂÖ±ÂêåËÆ∞ÂøÜ: ${sharedMemories.join('; ')}` : ''}

‰∫íÂä®Á±ªÂûã: ${INTERACTION_TYPES.find(t => t.id === interactionType)?.zh}

ËøîÂõûJSONÊ†ºÂºèÔºö
{
  "dialogue": [
    {"speaker": "ÂêçÂ≠ó", "text": "ËØ¥ÁöÑËØù", "action": "Âä®‰ΩúÂèØÈÄâ"}
  ],
  "outcome": "positive" | "neutral" | "negative",
  "traitChangesA": {"traitÂêç": -5Âà∞5},
  "traitChangesB": {"traitÂêç": -5Âà∞5},
  "relationChange": -1Âà∞2,
  "newSharedMemory": "ÂÖ±ÂêåËÆ∞ÂøÜÊàñnull",
  "summary": "‰∏ÄÂè•ËØùÊÄªÁªìÔºà15Â≠óÔºâ"
}

Âè™ËøîÂõûJSON`;

      const result = await callClaude([{ role: 'user', content: prompt }], 800);
      
      try {
        const jsonMatch = result.match(/\{[\s\S]*\}/);
        if (jsonMatch) return JSON.parse(jsonMatch[0]);
      } catch {}
      
      return {
        dialogue: [
          { speaker: monkey1.name, text: '‰Ω†Â•ΩÂëÄÔºÅ', action: 'Êå•Êâã' },
          { speaker: monkey2.name, text: '‰Ω†Â•Ω~', action: 'ÂæÆÁ¨ë' },
        ],
        outcome: 'positive',
        traitChangesA: { socialSkill: 1 },
        traitChangesB: { socialSkill: 1 },
        relationChange: 1,
        newSharedMemory: 'Á¨¨‰∏ÄÊ¨°ËßÅÈù¢',
        summary: 'ÂèãÂ•ΩÁöÑÁõ∏ÈÅá',
      };
    }

    async function generateMonkeyResponse(monkey, message) {
      const prompt = `‰Ω†ÊòØ"${monkey.name}"Ôºå‰∏ÄÂè™${monkey.age}Âë®Â§ßÁöÑÂ∞èÁå¥Â≠ê„ÄÇ
ÊÄßÊ†º: ${monkey.personality}
Áî®1-2Âè•ËØùÂõûÂ∫îÂÆ∂ÈïøÔºåÁ¨¶ÂêàÊÄßÊ†ºÔºåÂèØÁî®ËØ≠Ê∞îËØçÂ¶Ç"Âòõ""ÂëÄ"ÔºåÂèØÂä†Âä®‰ΩúÂ¶Ç"ÔºàÊ≠™Â§¥Ôºâ"

ÂÆ∂ÈïøËØ¥Ôºö"${message}"`;

      const result = await callClaude([{ role: 'user', content: prompt }], 100);
      return result || 'ÔºàÁú®Áú®ÁúºÁúãÁùÄ‰Ω†Ôºâ';
    }

    // ============================================
    // MONKEY PLAZA - Canvas Game Map
    // ============================================

    const MonkeyPlaza = ({ monkeys, myMonkey, friends, onInteract, t }) => {
      const canvasRef = React.useRef(null);
      const [showMenu, setShowMenu] = React.useState(false);
      const [menuPosition, setMenuPosition] = React.useState({ x: 0, y: 0 });
      const [menuMonkey, setMenuMonkey] = React.useState(null);
      const gameStateRef = React.useRef({
        monkeySprites: [],
        trees: [],
        flowers: [],
        rocks: [],
        clouds: [],
        butterflies: [],
        initialized: false,
      });

      const COLORS = {
        grass1: '#7CB342',
        grass2: '#8BC34A', 
        grass3: '#9CCC65',
        grassDark: '#689F38',
        tree: '#2E7D32',
        treeLight: '#43A047',
        treeTrunk: '#5D4037',
        water: '#4FC3F7',
        waterLight: '#81D4FA',
        waterDark: '#29B6F6',
        rock: '#78909C',
        rockLight: '#90A4AE',
        rockDark: '#546E7A',
        path: '#D7CCC8',
        pathDark: '#BCAAA4',
        flower: ['#F48FB1', '#CE93D8', '#FFF176', '#FFAB91', '#80DEEA', '#A5D6A7'],
        monkey: { body: '#8D6E63', bodyLight: '#A1887F', face: '#FFCCBC', faceDark: '#FFAB91' },
      };

      // Monkey sprite class
      class MonkeySprite {
        constructor(data, x, y, isPlayer) {
          this.data = data;
          this.x = x;
          this.y = y;
          this.targetX = x;
          this.targetY = y;
          this.isPlayer = isPlayer;
          this.size = isPlayer ? 38 : 32;
          this.animTimer = Math.random() * 1000;
          this.bobOffset = 0;
          this.blinkTimer = Math.random() * 3000;
          this.isBlinking = false;
          this.state = 'idle';
          this.direction = Math.random() > 0.5 ? 1 : -1;
          this.nextMoveTime = 2000 + Math.random() * 5000;
          this.speed = 0.08 + Math.random() * 0.05; // Even slower speed
        }

        update(deltaTime, width, height) {
          this.animTimer += deltaTime;
          this.bobOffset = Math.sin(this.animTimer * 0.002) * 1.5; // Slower bob
          
          // Blinking
          this.blinkTimer -= deltaTime;
          if (this.blinkTimer <= 0) {
            this.isBlinking = true;
            setTimeout(() => this.isBlinking = false, 150);
            this.blinkTimer = 2000 + Math.random() * 4000;
          }

          // State from mood
          if (this.data.mood?.energy < 20) this.state = 'sleeping';
          else if (this.data.mood?.loneliness > 70) this.state = 'sad';
          else this.state = 'idle';

          // Random movement - very slow and small range
          if (this.state !== 'sleeping') {
            this.nextMoveTime -= deltaTime;
            if (this.nextMoveTime <= 0) {
              // Move within a small radius of starting position
              this.targetX = this.x + (Math.random() - 0.5) * 80;
              this.targetY = this.y + (Math.random() - 0.5) * 60;
              // Keep in bounds
              this.targetX = Math.max(50, Math.min(width - 50, this.targetX));
              this.targetY = Math.max(100, Math.min(height - 100, this.targetY));
              this.nextMoveTime = 5000 + Math.random() * 10000; // Wait much longer
            }
          }

          // Move very slowly
          const dx = this.targetX - this.x;
          const dy = this.targetY - this.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist > 3) {
            this.x += (dx / dist) * this.speed;
            this.y += (dy / dist) * this.speed;
            this.direction = dx > 0 ? 1 : -1;
          }
          this.x = Math.max(30, Math.min(width - 30, this.x));
          this.y = Math.max(80, Math.min(height - 80, this.y));
        }

        draw(ctx) {
          ctx.save();
          ctx.translate(this.x, this.y + this.bobOffset);
          ctx.scale(this.direction, 1);
          const s = this.size;

          // Shadow - softer
          ctx.fillStyle = 'rgba(0,0,0,0.12)';
          ctx.beginPath();
          ctx.ellipse(0, s * 0.38, s * 0.38, s * 0.1, 0, 0, Math.PI * 2);
          ctx.fill();

          // Body
          const bodyGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, s * 0.4);
          bodyGrad.addColorStop(0, COLORS.monkey.bodyLight);
          bodyGrad.addColorStop(1, COLORS.monkey.body);
          ctx.fillStyle = bodyGrad;
          ctx.beginPath();
          ctx.ellipse(0, 0, s * 0.3, s * 0.36, 0, 0, Math.PI * 2);
          ctx.fill();

          // Head
          ctx.beginPath();
          ctx.arc(0, -s * 0.3, s * 0.26, 0, Math.PI * 2);
          ctx.fill();

          // Ears
          ctx.beginPath();
          ctx.arc(-s * 0.24, -s * 0.36, s * 0.1, 0, Math.PI * 2);
          ctx.arc(s * 0.24, -s * 0.36, s * 0.1, 0, Math.PI * 2);
          ctx.fill();
          
          // Inner ears
          ctx.fillStyle = COLORS.monkey.faceDark;
          ctx.beginPath();
          ctx.arc(-s * 0.24, -s * 0.36, s * 0.055, 0, Math.PI * 2);
          ctx.arc(s * 0.24, -s * 0.36, s * 0.055, 0, Math.PI * 2);
          ctx.fill();

          // Face
          const faceGrad = ctx.createRadialGradient(0, -s * 0.26, 0, 0, -s * 0.26, s * 0.18);
          faceGrad.addColorStop(0, COLORS.monkey.face);
          faceGrad.addColorStop(1, COLORS.monkey.faceDark);
          ctx.fillStyle = faceGrad;
          ctx.beginPath();
          ctx.ellipse(0, -s * 0.24, s * 0.17, s * 0.14, 0, 0, Math.PI * 2);
          ctx.fill();

          // Eyes
          if (this.state === 'sleeping' || this.isBlinking) {
            ctx.strokeStyle = '#4E342E';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(-s * 0.07, -s * 0.3, s * 0.03, 0, Math.PI, true);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(s * 0.07, -s * 0.3, s * 0.03, 0, Math.PI, true);
            ctx.stroke();
          } else {
            // Eye whites
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.ellipse(-s * 0.07, -s * 0.3, s * 0.045, s * 0.05, 0, 0, Math.PI * 2);
            ctx.ellipse(s * 0.07, -s * 0.3, s * 0.045, s * 0.05, 0, 0, Math.PI * 2);
            ctx.fill();
            // Pupils
            ctx.fillStyle = '#3E2723';
            ctx.beginPath();
            ctx.arc(-s * 0.06, -s * 0.29, s * 0.025, 0, Math.PI * 2);
            ctx.arc(s * 0.08, -s * 0.29, s * 0.025, 0, Math.PI * 2);
            ctx.fill();
            // Eye shine
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.arc(-s * 0.05, -s * 0.31, s * 0.01, 0, Math.PI * 2);
            ctx.arc(s * 0.09, -s * 0.31, s * 0.01, 0, Math.PI * 2);
            ctx.fill();
          }

          // Nose
          ctx.fillStyle = '#5D4037';
          ctx.beginPath();
          ctx.ellipse(0, -s * 0.22, s * 0.025, s * 0.018, 0, 0, Math.PI * 2);
          ctx.fill();

          // Mouth
          ctx.strokeStyle = '#5D4037';
          ctx.lineWidth = 1.2;
          if (this.state === 'sad') {
            ctx.beginPath();
            ctx.arc(0, -s * 0.14, s * 0.04, 0.3 * Math.PI, 0.7 * Math.PI, true);
            ctx.stroke();
          } else if (this.data.mood?.happiness > 60) {
            ctx.beginPath();
            ctx.arc(0, -s * 0.18, s * 0.04, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();
          } else {
            ctx.beginPath();
            ctx.moveTo(-s * 0.03, -s * 0.16);
            ctx.lineTo(s * 0.03, -s * 0.16);
            ctx.stroke();
          }

          // Arms
          ctx.fillStyle = COLORS.monkey.body;
          ctx.beginPath();
          ctx.ellipse(-s * 0.28, s * 0.05, s * 0.08, s * 0.15, -0.3, 0, Math.PI * 2);
          ctx.ellipse(s * 0.28, s * 0.05, s * 0.08, s * 0.15, 0.3, 0, Math.PI * 2);
          ctx.fill();

          // Tail
          ctx.strokeStyle = COLORS.monkey.body;
          ctx.lineWidth = s * 0.06;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(0, s * 0.2);
          ctx.bezierCurveTo(s * 0.3, s * 0.25, s * 0.4, s * 0.05, s * 0.3, -s * 0.12);
          ctx.stroke();

          ctx.restore();

          // Status bubble with background
          let emoji = null;
          if (this.state === 'sleeping') emoji = 'üí§';
          else if (this.data.mood?.loneliness > 70) emoji = 'ü•∫';
          else if (this.data.mood?.happiness > 80) emoji = '‚ú®';
          else if (this.data.pendingMessage) emoji = 'üí¨';
          
          if (emoji) {
            ctx.fillStyle = 'rgba(255,255,255,0.85)';
            ctx.beginPath();
            ctx.arc(this.x + s * 0.35, this.y - s * 0.75 + this.bobOffset, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.font = '13px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(emoji, this.x + s * 0.35, this.y - s * 0.71 + this.bobOffset);
          }

          // Name tag with nicer styling
          ctx.font = 'bold 10px system-ui';
          ctx.textAlign = 'center';
          const name = this.data.name;
          const tw = ctx.measureText(name).width;
          
          // Tag background
          ctx.fillStyle = this.isPlayer ? '#FFC107' : 'rgba(33,33,33,0.75)';
          ctx.beginPath();
          ctx.roundRect(this.x - tw / 2 - 6, this.y + s * 0.45, tw + 12, 16, 8);
          ctx.fill();
          
          // Tag text
          ctx.fillStyle = this.isPlayer ? '#212121' : '#FFF';
          ctx.fillText(name, this.x, this.y + s * 0.45 + 11);

          // Player crown
          if (this.isPlayer) {
            ctx.fillStyle = '#FFC107';
            ctx.strokeStyle = '#FF8F00';
            ctx.lineWidth = 1;
            const cy = this.y - s - 8 + this.bobOffset;
            ctx.beginPath();
            ctx.moveTo(this.x - 8, cy + 8);
            ctx.lineTo(this.x - 8, cy + 2);
            ctx.lineTo(this.x - 4, cy + 5);
            ctx.lineTo(this.x, cy);
            ctx.lineTo(this.x + 4, cy + 5);
            ctx.lineTo(this.x + 8, cy + 2);
            ctx.lineTo(this.x + 8, cy + 8);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
          }
        }

        containsPoint(px, py) {
          const dx = px - this.x;
          const dy = py - this.y;
          return Math.sqrt(dx * dx + dy * dy) < this.size * 1.2;
        }
      }

      // Butterfly class
      class Butterfly {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.targetX = x;
          this.targetY = y;
          this.wingAngle = 0;
          this.color = COLORS.flower[Math.floor(Math.random() * COLORS.flower.length)];
          this.nextMoveTime = 0;
        }
        
        update(dt, w, h) {
          this.wingAngle += dt * 0.02;
          this.nextMoveTime -= dt;
          if (this.nextMoveTime <= 0) {
            this.targetX = 30 + Math.random() * (w - 60);
            this.targetY = 50 + Math.random() * (h - 150);
            this.nextMoveTime = 2000 + Math.random() * 3000;
          }
          const dx = this.targetX - this.x;
          const dy = this.targetY - this.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist > 2) {
            this.x += (dx / dist) * 0.3;
            this.y += (dy / dist) * 0.3 + Math.sin(this.wingAngle) * 0.2;
          }
        }
        
        draw(ctx) {
          const wing = Math.sin(this.wingAngle) * 0.5 + 0.5;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.ellipse(this.x - 4 * wing, this.y, 4, 6 * wing, -0.3, 0, Math.PI * 2);
          ctx.ellipse(this.x + 4 * wing, this.y, 4, 6 * wing, 0.3, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#333';
          ctx.fillRect(this.x - 0.5, this.y - 4, 1, 8);
        }
      }

      // Draw functions
      const drawBackground = (ctx, w, h, t) => {
        const hour = new Date().getHours();
        let colors;
        if (hour >= 6 && hour < 8) {
          colors = { top: '#FFE0B2', mid: '#FFCC80', bot: '#FFF3E0' }; // Dawn
        } else if (hour >= 8 && hour < 17) {
          colors = { top: '#64B5F6', mid: '#90CAF9', bot: '#E3F2FD' }; // Day
        } else if (hour >= 17 && hour < 19) {
          colors = { top: '#FF8A65', mid: '#FFAB91', bot: '#FFE0B2' }; // Sunset
        } else if (hour >= 19 && hour < 21) {
          colors = { top: '#5C6BC0', mid: '#7986CB', bot: '#C5CAE9' }; // Dusk
        } else {
          colors = { top: '#1A237E', mid: '#283593', bot: '#3949AB' }; // Night
        }
        
        const grad = ctx.createLinearGradient(0, 0, 0, h * 0.5);
        grad.addColorStop(0, colors.top);
        grad.addColorStop(0.5, colors.mid);
        grad.addColorStop(1, colors.bot);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h * 0.5);

        // Grass with gradient
        const grassGrad = ctx.createLinearGradient(0, h * 0.35, 0, h);
        grassGrad.addColorStop(0, COLORS.grass2);
        grassGrad.addColorStop(0.5, COLORS.grass1);
        grassGrad.addColorStop(1, COLORS.grass3);
        ctx.fillStyle = grassGrad;
        ctx.fillRect(0, h * 0.35, w, h * 0.65);

        // Grass tufts
        ctx.fillStyle = COLORS.grassDark;
        for (let i = 0; i < 80; i++) {
          const gx = (i * 43 + Math.sin(t * 0.0003 + i) * 2) % w;
          const gy = h * 0.38 + (i * 31) % (h * 0.5);
          ctx.beginPath();
          ctx.moveTo(gx, gy + 8);
          ctx.quadraticCurveTo(gx - 2, gy + 2, gx, gy);
          ctx.quadraticCurveTo(gx + 2, gy + 2, gx, gy + 8);
          ctx.fill();
        }
      };

      const drawClouds = (ctx, clouds, t, w) => {
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        clouds.forEach(c => {
          const x = (c.x + t * 0.005 * c.speed) % (w + 100) - 50;
          ctx.beginPath();
          ctx.arc(x, c.y, c.size, 0, Math.PI * 2);
          ctx.arc(x + c.size * 0.6, c.y - c.size * 0.2, c.size * 0.7, 0, Math.PI * 2);
          ctx.arc(x + c.size * 1.2, c.y, c.size * 0.8, 0, Math.PI * 2);
          ctx.fill();
        });
      };

      const drawPath = (ctx, w, h) => {
        ctx.fillStyle = COLORS.path;
        ctx.beginPath();
        ctx.moveTo(0, h * 0.6);
        ctx.quadraticCurveTo(w * 0.3, h * 0.55, w * 0.5, h * 0.65);
        ctx.quadraticCurveTo(w * 0.7, h * 0.75, w, h * 0.7);
        ctx.lineTo(w, h * 0.75);
        ctx.quadraticCurveTo(w * 0.7, h * 0.8, w * 0.5, h * 0.7);
        ctx.quadraticCurveTo(w * 0.3, h * 0.6, 0, h * 0.65);
        ctx.closePath();
        ctx.fill();
        
        // Path details
        ctx.fillStyle = COLORS.pathDark;
        for (let i = 0; i < 20; i++) {
          const px = (i / 20) * w;
          const py = h * 0.62 + Math.sin(i * 0.8) * h * 0.05;
          ctx.beginPath();
          ctx.arc(px, py, 2, 0, Math.PI * 2);
          ctx.fill();
        }
      };

      const drawTrees = (ctx, trees, t) => {
        trees.forEach(tree => {
          const sw = Math.sin(t * 0.0008 + tree.x * 0.01) * 2;
          
          // Shadow
          ctx.fillStyle = 'rgba(0,0,0,0.1)';
          ctx.beginPath();
          ctx.ellipse(tree.x + 10, tree.y + 5, 25, 8, 0, 0, Math.PI * 2);
          ctx.fill();
          
          // Trunk
          ctx.fillStyle = COLORS.treeTrunk;
          ctx.beginPath();
          ctx.moveTo(tree.x - 8, tree.y);
          ctx.lineTo(tree.x - 5, tree.y - 45);
          ctx.lineTo(tree.x + 5, tree.y - 45);
          ctx.lineTo(tree.x + 8, tree.y);
          ctx.closePath();
          ctx.fill();
          
          // Foliage layers
          ctx.fillStyle = COLORS.tree;
          ctx.beginPath();
          ctx.arc(tree.x + sw, tree.y - 55, 28, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = COLORS.treeLight;
          ctx.beginPath();
          ctx.arc(tree.x - 12 + sw, tree.y - 42, 20, 0, Math.PI * 2);
          ctx.arc(tree.x + 14 + sw, tree.y - 45, 22, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = COLORS.tree;
          ctx.beginPath();
          ctx.arc(tree.x + sw * 0.5, tree.y - 65, 18, 0, Math.PI * 2);
          ctx.fill();
        });
      };

      const drawRocks = (ctx, rocks) => {
        rocks.forEach(r => {
          // Main rock
          ctx.fillStyle = COLORS.rock;
          ctx.beginPath();
          ctx.ellipse(r.x, r.y, r.size, r.size * 0.6, 0, 0, Math.PI * 2);
          ctx.fill();
          // Highlight
          ctx.fillStyle = COLORS.rockLight;
          ctx.beginPath();
          ctx.ellipse(r.x - r.size * 0.2, r.y - r.size * 0.15, r.size * 0.4, r.size * 0.25, -0.3, 0, Math.PI * 2);
          ctx.fill();
        });
      };

      const drawFlowers = (ctx, flowers, t) => {
        flowers.forEach((f, i) => {
          const sw = Math.sin(t * 0.0015 + i * 0.5) * 1.5;
          // Stem
          ctx.strokeStyle = '#558B2F';
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.moveTo(f.x, f.y + 5);
          ctx.quadraticCurveTo(f.x + sw, f.y + 10, f.x, f.y + 18);
          ctx.stroke();
          // Petals
          ctx.fillStyle = f.color;
          for (let p = 0; p < 5; p++) {
            const angle = (p / 5) * Math.PI * 2 + t * 0.0002;
            ctx.beginPath();
            ctx.ellipse(
              f.x + Math.cos(angle) * 3 + sw,
              f.y + Math.sin(angle) * 3,
              3, 5, angle, 0, Math.PI * 2
            );
            ctx.fill();
          }
          // Center
          ctx.fillStyle = '#FFD54F';
          ctx.beginPath();
          ctx.arc(f.x + sw, f.y, 2.5, 0, Math.PI * 2);
          ctx.fill();
        });
      };

      const drawWater = (ctx, w, h, t) => {
        const wy = h * 0.88;
        
        // Water body with gradient
        const waterGrad = ctx.createLinearGradient(0, wy, 0, h);
        waterGrad.addColorStop(0, COLORS.waterLight);
        waterGrad.addColorStop(0.5, COLORS.water);
        waterGrad.addColorStop(1, COLORS.waterDark);
        
        ctx.fillStyle = waterGrad;
        ctx.beginPath();
        ctx.moveTo(0, wy);
        for (let x = 0; x <= w; x += 10) {
          ctx.lineTo(x, wy + Math.sin(x * 0.04 + t * 0.002) * 4);
        }
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.closePath();
        ctx.fill();

        // Sparkles
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        for (let i = 0; i < 8; i++) {
          const sx = (i * 50 + t * 0.02) % w;
          const sy = wy + 10 + Math.sin(t * 0.003 + i) * 5;
          ctx.beginPath();
          ctx.arc(sx, sy, 2 + Math.sin(t * 0.005 + i) * 1, 0, Math.PI * 2);
          ctx.fill();
        }
      };

      // Game loop
      React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const state = gameStateRef.current;

        if (!state.initialized) {
          // Trees - more spread out
          for (let i = 0; i < 8; i++) {
            state.trees.push({ 
              x: 50 + (i % 4) * (w / 4) + Math.random() * 80, 
              y: h * 0.35 + (i < 4 ? 0 : h * 0.25) + Math.random() * 40 
            });
          }
          // Flowers - more of them, spread across
          for (let i = 0; i < 45; i++) {
            state.flowers.push({ 
              x: 20 + Math.random() * (w - 40), 
              y: h * 0.38 + Math.random() * (h * 0.42), 
              color: COLORS.flower[Math.floor(Math.random() * COLORS.flower.length)] 
            });
          }
          // Rocks - spread across
          for (let i = 0; i < 8; i++) {
            state.rocks.push({
              x: 60 + Math.random() * (w - 120),
              y: h * 0.45 + Math.random() * (h * 0.3),
              size: 8 + Math.random() * 12
            });
          }
          // Clouds - more
          for (let i = 0; i < 6; i++) {
            state.clouds.push({
              x: Math.random() * w,
              y: 25 + Math.random() * 70,
              size: 18 + Math.random() * 28,
              speed: 0.3 + Math.random() * 0.4
            });
          }
          // Butterflies - more
          for (let i = 0; i < 5; i++) {
            state.butterflies.push(new Butterfly(
              60 + Math.random() * (w - 120),
              100 + Math.random() * (h - 280)
            ));
          }
          state.initialized = true;
        }

        // Update sprites from data
        state.monkeySprites = monkeys.map((m, idx) => {
          const existing = state.monkeySprites.find(s => s.data.odId === m.odId);
          if (existing) {
            existing.data = m;
            return existing;
          }
          const isPlayer = m.odId === myMonkey?.odId;
          // Spread monkeys evenly across the map
          const cols = 4;
          const rows = Math.ceil(monkeys.length / cols);
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          const cellW = (w - 120) / cols;
          const cellH = (h - 200) / Math.max(rows, 1);
          const startX = 80 + col * cellW + Math.random() * cellW * 0.6;
          const startY = 120 + row * cellH + Math.random() * cellH * 0.6;
          return new MonkeySprite(m, startX, startY, isPlayer);
        });

        let lastTime = 0;
        let animId;
        const loop = (ts) => {
          const dt = Math.min(ts - lastTime, 50); // Cap delta time
          lastTime = ts;
          ctx.clearRect(0, 0, w, h);
          
          drawBackground(ctx, w, h, ts);
          drawClouds(ctx, state.clouds, ts, w);
          drawPath(ctx, w, h);
          drawWater(ctx, w, h, ts);
          drawRocks(ctx, state.rocks);
          drawFlowers(ctx, state.flowers, ts);
          drawTrees(ctx, state.trees, ts);
          
          // Update and draw butterflies
          state.butterflies.forEach(b => {
            b.update(dt, w, h);
            b.draw(ctx);
          });
          
          // Update and draw monkeys (sorted by Y)
          state.monkeySprites.sort((a, b) => a.y - b.y);
          state.monkeySprites.forEach(m => {
            m.update(dt, w, h * 0.85);
            m.draw(ctx);
          });
          
          animId = requestAnimationFrame(loop);
        };
        animId = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(animId);
      }, [monkeys, myMonkey]);

      // Click handler
      const handleClick = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        const state = gameStateRef.current;
        for (const m of state.monkeySprites) {
          if (m.containsPoint(x, y)) {
            setMenuMonkey(m.data);
            setMenuPosition({ x: e.clientX, y: e.clientY });
            setShowMenu(true);
            return;
          }
        }
        setShowMenu(false);
      };

      return (
        <div style={{ position: 'relative', width: '100%', aspectRatio: '16/10' }}>
          <canvas ref={canvasRef} width={640} height={500} onClick={handleClick}
            style={{ width: '100%', height: '100%', borderRadius: 20, cursor: 'pointer', boxShadow: '0 8px 32px rgba(0,0,0,0.3)' }} />
          {showMenu && menuMonkey && (
            <div style={{
              position: 'fixed', left: menuPosition.x, top: menuPosition.y, transform: 'translate(-50%, -100%)',
              background: 'linear-gradient(135deg, rgba(26,26,46,0.98), rgba(45,45,80,0.98))', 
              borderRadius: 16, padding: 16,
              border: '1px solid rgba(255,255,255,0.15)', 
              boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
              zIndex: 100, minWidth: 160,
            }}>
              <div style={{ fontWeight: 700, marginBottom: 6, color: '#FFC107', fontSize: 15 }}>{menuMonkey.name}</div>
              <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginBottom: 12 }}>{menuMonkey.ownerName} ÁöÑÁå¥Â≠ê</div>
              {menuMonkey.odId === myMonkey?.odId ? (
                <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', textAlign: 'center', padding: '8px 0' }}>
                  üëë ËøôÊòØ‰Ω†ÁöÑÁå¥Â≠êÔºÅ
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  <button onClick={() => { onInteract(menuMonkey, 'wave'); setShowMenu(false); }}
                    style={{ padding: '10px 12px', background: 'linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05))', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, color: '#fff', cursor: 'pointer', fontSize: 13, transition: 'all 0.2s' }}>
                    üëã {t('ÊâìÊãõÂëº', 'Wave')}
                  </button>
                  <button onClick={() => { onInteract(menuMonkey, 'play'); setShowMenu(false); }}
                    style={{ padding: '10px 12px', background: 'linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05))', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, color: '#fff', cursor: 'pointer', fontSize: 13 }}>
                    üéÆ {t('‰∏ÄËµ∑Áé©', 'Play')}
                  </button>
                  <button onClick={() => { onInteract(menuMonkey, 'gift'); setShowMenu(false); }}
                    style={{ padding: '10px 12px', background: 'linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05))', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, color: '#fff', cursor: 'pointer', fontSize: 13 }}>
                    üçå {t('ÈÄÅÈ¶ôËïâ', 'Gift')}
                  </button>
                </div>
              )}
              <button onClick={() => setShowMenu(false)}
                style={{ marginTop: 10, padding: '6px', background: 'transparent', border: 'none', color: 'rgba(255,255,255,0.4)', cursor: 'pointer', fontSize: 11, width: '100%' }}>
                ‚úï {t('ÂÖ≥Èó≠', 'Close')}
              </button>
            </div>
          )}
          <div style={{ 
            position: 'absolute', bottom: 12, left: 12, 
            background: 'rgba(0,0,0,0.6)', borderRadius: 10, 
            padding: '6px 12px', fontSize: 11, color: 'rgba(255,255,255,0.8)',
            backdropFilter: 'blur(4px)'
          }}>
            üëë {t('‰Ω†', 'You')} ¬∑ üëÜ {t('ÁÇπÂáª‰∫íÂä®', 'Tap to interact')}
          </div>
          <div style={{ 
            position: 'absolute', top: 12, right: 12, 
            background: 'rgba(0,0,0,0.6)', borderRadius: 10, 
            padding: '6px 12px', fontSize: 12, color: '#fff',
            backdropFilter: 'blur(4px)'
          }}>
            üêµ {monkeys.length} {t('Âú®Á∫ø', 'online')}
          </div>
        </div>
      );
    };

    // ============================================
    // ANIMATED MONKEY (for home page)
    // ============================================

    const AnimatedMonkey = ({ monkey, size = 120 }) => {
      const canvasRef = React.useRef(null);
      
      React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        
        let animTimer = 0;
        let blinkTimer = Math.random() * 2000;
        let isBlinking = false;
        let actionTimer = 0;
        let currentAction = 'idle'; // idle, wave, jump, scratch
        let actionFrame = 0;
        
        const COLORS = {
          body: '#8D6E63',
          bodyLight: '#A1887F',
          face: '#FFCCBC',
          faceDark: '#FFAB91',
        };

        const draw = (timestamp) => {
          const dt = 16;
          animTimer += dt;
          
          // Blinking
          blinkTimer -= dt;
          if (blinkTimer <= 0) {
            isBlinking = true;
            setTimeout(() => isBlinking = false, 150);
            blinkTimer = 2000 + Math.random() * 3000;
          }
          
          // Random actions
          actionTimer -= dt;
          if (actionTimer <= 0 && currentAction === 'idle') {
            const actions = ['wave', 'jump', 'scratch', 'idle', 'idle'];
            currentAction = actions[Math.floor(Math.random() * actions.length)];
            actionFrame = 0;
            actionTimer = currentAction === 'idle' ? 2000 + Math.random() * 3000 : 1000;
          }
          if (currentAction !== 'idle') {
            actionFrame += dt * 0.01;
            if (actionFrame > 1) {
              currentAction = 'idle';
              actionTimer = 2000 + Math.random() * 3000;
            }
          }

          ctx.clearRect(0, 0, w, h);
          
          const cx = w / 2;
          const cy = h / 2 + 10;
          const s = size * 0.35;
          
          // Bounce for jump
          let bounceY = 0;
          if (currentAction === 'jump') {
            bounceY = -Math.sin(actionFrame * Math.PI) * 15;
          }
          
          // Idle bob
          const bob = Math.sin(animTimer * 0.003) * 2;
          
          ctx.save();
          ctx.translate(cx, cy + bob + bounceY);

          // Shadow
          ctx.fillStyle = 'rgba(0,0,0,0.15)';
          ctx.beginPath();
          ctx.ellipse(0, s * 0.5 - bounceY, s * 0.5, s * 0.12, 0, 0, Math.PI * 2);
          ctx.fill();

          // Body
          const bodyGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, s * 0.5);
          bodyGrad.addColorStop(0, COLORS.bodyLight);
          bodyGrad.addColorStop(1, COLORS.body);
          ctx.fillStyle = bodyGrad;
          ctx.beginPath();
          ctx.ellipse(0, 0, s * 0.38, s * 0.45, 0, 0, Math.PI * 2);
          ctx.fill();

          // Legs
          ctx.fillStyle = COLORS.body;
          const legKick = currentAction === 'jump' ? Math.sin(actionFrame * Math.PI * 2) * 0.3 : 0;
          ctx.save();
          ctx.translate(-s * 0.15, s * 0.35);
          ctx.rotate(legKick);
          ctx.beginPath();
          ctx.ellipse(0, s * 0.12, s * 0.1, s * 0.15, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
          ctx.save();
          ctx.translate(s * 0.15, s * 0.35);
          ctx.rotate(-legKick);
          ctx.beginPath();
          ctx.ellipse(0, s * 0.12, s * 0.1, s * 0.15, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();

          // Left arm
          ctx.save();
          ctx.translate(-s * 0.38, -s * 0.05);
          let leftArmAngle = Math.sin(animTimer * 0.002) * 0.1;
          if (currentAction === 'wave') {
            leftArmAngle = -0.5 + Math.sin(actionFrame * Math.PI * 4) * 0.5;
          }
          ctx.rotate(leftArmAngle);
          ctx.beginPath();
          ctx.ellipse(0, s * 0.15, s * 0.09, s * 0.18, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();

          // Right arm
          ctx.save();
          ctx.translate(s * 0.38, -s * 0.05);
          let rightArmAngle = -Math.sin(animTimer * 0.002) * 0.1;
          if (currentAction === 'scratch') {
            ctx.translate(0, -s * 0.2);
            rightArmAngle = -1.2 + Math.sin(actionFrame * Math.PI * 6) * 0.3;
          }
          ctx.rotate(rightArmAngle);
          ctx.beginPath();
          ctx.ellipse(0, s * 0.15, s * 0.09, s * 0.18, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();

          // Head
          ctx.fillStyle = bodyGrad;
          ctx.beginPath();
          ctx.arc(0, -s * 0.38, s * 0.32, 0, Math.PI * 2);
          ctx.fill();

          // Ears
          ctx.beginPath();
          ctx.arc(-s * 0.3, -s * 0.45, s * 0.12, 0, Math.PI * 2);
          ctx.arc(s * 0.3, -s * 0.45, s * 0.12, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = COLORS.faceDark;
          ctx.beginPath();
          ctx.arc(-s * 0.3, -s * 0.45, s * 0.07, 0, Math.PI * 2);
          ctx.arc(s * 0.3, -s * 0.45, s * 0.07, 0, Math.PI * 2);
          ctx.fill();

          // Face
          const faceGrad = ctx.createRadialGradient(0, -s * 0.32, 0, 0, -s * 0.32, s * 0.22);
          faceGrad.addColorStop(0, COLORS.face);
          faceGrad.addColorStop(1, COLORS.faceDark);
          ctx.fillStyle = faceGrad;
          ctx.beginPath();
          ctx.ellipse(0, -s * 0.3, s * 0.2, s * 0.17, 0, 0, Math.PI * 2);
          ctx.fill();

          // Eyes
          const mood = monkey?.mood || { happiness: 70, energy: 70 };
          const isSleeping = mood.energy < 20;
          
          if (isSleeping || isBlinking) {
            ctx.strokeStyle = '#4E342E';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(-s * 0.08, -s * 0.38, s * 0.04, 0, Math.PI, true);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(s * 0.08, -s * 0.38, s * 0.04, 0, Math.PI, true);
            ctx.stroke();
          } else {
            // Eye whites
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.ellipse(-s * 0.08, -s * 0.38, s * 0.055, s * 0.06, 0, 0, Math.PI * 2);
            ctx.ellipse(s * 0.08, -s * 0.38, s * 0.055, s * 0.06, 0, 0, Math.PI * 2);
            ctx.fill();
            // Pupils - look around slightly
            const lookX = Math.sin(animTimer * 0.001) * s * 0.015;
            const lookY = Math.cos(animTimer * 0.0015) * s * 0.01;
            ctx.fillStyle = '#3E2723';
            ctx.beginPath();
            ctx.arc(-s * 0.07 + lookX, -s * 0.37 + lookY, s * 0.03, 0, Math.PI * 2);
            ctx.arc(s * 0.09 + lookX, -s * 0.37 + lookY, s * 0.03, 0, Math.PI * 2);
            ctx.fill();
            // Shine
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.arc(-s * 0.06, -s * 0.39, s * 0.012, 0, Math.PI * 2);
            ctx.arc(s * 0.1, -s * 0.39, s * 0.012, 0, Math.PI * 2);
            ctx.fill();
          }

          // Nose
          ctx.fillStyle = '#5D4037';
          ctx.beginPath();
          ctx.ellipse(0, -s * 0.28, s * 0.03, s * 0.02, 0, 0, Math.PI * 2);
          ctx.fill();

          // Mouth based on mood
          ctx.strokeStyle = '#5D4037';
          ctx.lineWidth = 1.5;
          if (isSleeping) {
            // Zzz
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillText('üí§', s * 0.3, -s * 0.6);
          } else if (mood.happiness > 70) {
            // Big smile
            ctx.beginPath();
            ctx.arc(0, -s * 0.22, s * 0.06, 0.1 * Math.PI, 0.9 * Math.PI);
            ctx.stroke();
            // Blush
            ctx.fillStyle = 'rgba(255,138,128,0.3)';
            ctx.beginPath();
            ctx.ellipse(-s * 0.15, -s * 0.28, s * 0.04, s * 0.025, 0, 0, Math.PI * 2);
            ctx.ellipse(s * 0.15, -s * 0.28, s * 0.04, s * 0.025, 0, 0, Math.PI * 2);
            ctx.fill();
          } else if (mood.happiness < 30) {
            // Sad
            ctx.beginPath();
            ctx.arc(0, -s * 0.18, s * 0.04, 0.3 * Math.PI, 0.7 * Math.PI, true);
            ctx.stroke();
          } else {
            // Neutral
            ctx.beginPath();
            ctx.moveTo(-s * 0.04, -s * 0.2);
            ctx.lineTo(s * 0.04, -s * 0.2);
            ctx.stroke();
          }

          // Tail
          ctx.strokeStyle = COLORS.body;
          ctx.lineWidth = s * 0.08;
          ctx.lineCap = 'round';
          const tailWag = Math.sin(animTimer * 0.005) * 0.2;
          ctx.beginPath();
          ctx.moveTo(s * 0.1, s * 0.25);
          ctx.bezierCurveTo(
            s * 0.4 + tailWag * 20, s * 0.3,
            s * 0.5 + tailWag * 30, s * 0.1,
            s * 0.4 + tailWag * 25, -s * 0.15
          );
          ctx.stroke();

          ctx.restore();

          requestAnimationFrame(draw);
        };

        const animId = requestAnimationFrame(draw);
        return () => cancelAnimationFrame(animId);
      }, [monkey, size]);

      return (
        <canvas
          ref={canvasRef}
          width={size}
          height={size}
          style={{ width: size, height: size }}
        />
      );
    };

    // ============================================
    // COMPONENTS
    // ============================================

    const MonkeyFace = ({ state = 'neutral', traits, size = 'normal' }) => {
      const expressions = {
        neutral: { eyes: '‚ó†‚ó†', mouth: '‚ó°' },
        happy: { eyes: '‚ó†‚ó†', mouth: '‚ñΩ' },
        sad: { eyes: '‚ï•‚ï•', mouth: 'Ô∏µ' },
        excited: { eyes: '‚òÖ‚òÖ', mouth: '‚ñΩ' },
        nervous: { eyes: '‚óâ‚óâ', mouth: 'ÔΩû' },
        love: { eyes: '‚ô•‚ô•', mouth: '‚ñΩ' },
      };
      
      const expr = expressions[state] || expressions.neutral;
      const avgTrait = traits ? Object.values(traits).reduce((a, b) => a + b, 0) / Object.keys(traits).length : 50;
      const healthColor = avgTrait > 60 ? '#4ade80' : avgTrait > 40 ? '#fbbf24' : '#f87171';
      const scale = size === 'small' ? 0.5 : size === 'tiny' ? 0.35 : 1;

      return (
        <div style={{ transform: `scale(${scale})`, transformOrigin: 'center' }}>
          <div style={{ position: 'relative', width: 120, height: 140, margin: '0 auto' }}>
            <div style={{
              position: 'absolute', width: 150, height: 150, borderRadius: '50%',
              background: healthColor, filter: 'blur(40px)', opacity: 0.4, top: -15, left: -15,
              animation: 'pulse 3s ease-in-out infinite',
            }} />
            <div style={{ position: 'relative', zIndex: 1 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: -20, padding: '0 5px' }}>
                {[0, 1].map(i => (
                  <div key={i} style={{
                    width: 35, height: 35, background: 'linear-gradient(145deg, #8B4513, #A0522D)',
                    borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center',
                  }}>
                    <div style={{ width: 18, height: 18, background: '#DEB887', borderRadius: '50%' }} />
                  </div>
                ))}
              </div>
              <div style={{
                width: 120, height: 110, background: 'linear-gradient(180deg, #8B4513, #A0522D)',
                borderRadius: '50% 50% 45% 45%', display: 'flex', alignItems: 'center',
                justifyContent: 'center', boxShadow: '0 8px 25px rgba(0,0,0,0.3)',
              }}>
                <div style={{
                  width: 85, height: 75, background: 'linear-gradient(180deg, #FFDAB9, #DEB887)',
                  borderRadius: '45%', display: 'flex', flexDirection: 'column',
                  alignItems: 'center', justifyContent: 'center',
                }}>
                  <div style={{ fontSize: 22, letterSpacing: 10, marginLeft: 10, color: '#2d1810' }}>{expr.eyes}</div>
                  <div style={{ fontSize: 14, color: '#8B4513', marginTop: -3 }}>œâ</div>
                  <div style={{ fontSize: 18, color: '#5D3A1A', marginTop: -2 }}>{expr.mouth}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const TraitBar = ({ name, value, change = 0, compact = false }) => {
      const color = value >= 70 ? '#4ade80' : value >= 40 ? '#fbbf24' : '#f87171';
      return (
        <div style={{ marginBottom: compact ? 4 : 8 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 3, fontSize: compact ? 11 : 13 }}>
            <span style={{ color: 'rgba(255,255,255,0.7)', minWidth: compact ? 50 : 60 }}>{name}</span>
            <span style={{ color: 'white', fontWeight: 600, fontFamily: 'monospace' }}>{Math.round(value)}</span>
            {change !== 0 && (
              <span style={{
                fontSize: 11, fontWeight: 700, padding: '1px 5px', borderRadius: 4,
                color: change > 0 ? '#4ade80' : '#f87171',
                background: change > 0 ? 'rgba(74,222,128,0.2)' : 'rgba(248,113,113,0.2)',
              }}>
                {change > 0 ? '+' : ''}{change}
              </span>
            )}
          </div>
          <div style={{ height: compact ? 4 : 6, background: 'rgba(255,255,255,0.1)', borderRadius: 3 }}>
            <div style={{ height: '100%', width: `${value}%`, background: color, borderRadius: 3, transition: 'width 0.5s' }} />
          </div>
        </div>
      );
    };

    const MonkeyCard = ({ monkey, onClick, isMe = false, relation = null }) => {
      const relationLevel = relation?.level ?? -1;
      const relationName = relationLevel >= 0 ? RELATION_LEVELS[relationLevel] : null;
      const isOnline = monkey.lastActive && (Date.now() - monkey.lastActive) < 5 * 60 * 1000; // 5 minutes
      
      return (
        <div onClick={onClick} style={{
          background: isMe ? 'rgba(251,191,36,0.15)' : 'rgba(255,255,255,0.05)',
          border: `1px solid ${isMe ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.1)'}`,
          borderRadius: 16, padding: 16, cursor: onClick ? 'pointer' : 'default', transition: 'all 0.2s',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <div style={{ position: 'relative' }}>
              <MonkeyFace state="neutral" traits={monkey.traits} size="tiny" />
              {isOnline && (
                <div style={{
                  position: 'absolute', bottom: 5, right: 5, width: 12, height: 12,
                  background: '#4ade80', borderRadius: '50%', border: '2px solid #1a1a2e',
                }} />
              )}
            </div>
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <span style={{ fontWeight: 700, color: '#fbbf24', fontSize: 16 }}>{monkey.name}</span>
                {isMe && <span style={{ fontSize: 10, background: '#fbbf24', color: '#1a1a2e', padding: '2px 6px', borderRadius: 10, fontWeight: 700 }}>Êàë</span>}
              </div>
              <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginTop: 2 }}>
                {monkey.ownerName} ÁöÑÁå¥Â≠ê ¬∑ {monkey.age}Âë®Â§ß
              </div>
              <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', marginTop: 4 }}>
                {monkey.personality || 'ÂèØÁà±ÁöÑÂ∞èÁå¥Â≠ê'}
              </div>
              {relationName && (
                <div style={{
                  marginTop: 6, fontSize: 11, display: 'inline-block', padding: '2px 8px',
                  background: 'rgba(139,92,246,0.2)', border: '1px solid rgba(139,92,246,0.3)',
                  borderRadius: 10, color: '#a78bfa',
                }}>
                  {relationName}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const ChatBubble = ({ speaker, text, action, isLeft }) => (
      <div style={{
        display: 'flex', flexDirection: isLeft ? 'row' : 'row-reverse',
        gap: 10, marginBottom: 12, animation: 'fadeIn 0.3s',
      }}>
        <div style={{
          width: 36, height: 36, borderRadius: '50%',
          background: isLeft ? 'rgba(139,69,19,0.3)' : 'rgba(74,222,128,0.2)',
          display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 18, flexShrink: 0,
        }}>üêµ</div>
        <div style={{
          maxWidth: '70%', padding: '10px 14px', borderRadius: 16,
          background: isLeft ? 'rgba(139,69,19,0.2)' : 'rgba(74,222,128,0.15)',
          border: `1px solid ${isLeft ? 'rgba(139,69,19,0.3)' : 'rgba(74,222,128,0.25)'}`,
        }}>
          <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginBottom: 4 }}>{speaker}</div>
          {action && <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', fontStyle: 'italic', marginBottom: 4 }}>Ôºà{action}Ôºâ</div>}
          <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.9)', lineHeight: 1.5 }}>{text}</div>
        </div>
      </div>
    );

    const TabButton = ({ active, onClick, children, badge = 0 }) => (
      <button onClick={onClick} style={{
        flex: 1, padding: '12px 8px', background: active ? 'rgba(251,191,36,0.2)' : 'transparent',
        border: 'none', borderBottom: active ? '2px solid #fbbf24' : '2px solid transparent',
        color: active ? '#fbbf24' : 'rgba(255,255,255,0.6)', fontWeight: 600, fontSize: 14,
        cursor: 'pointer', position: 'relative', transition: 'all 0.2s',
      }}>
        {children}
        {badge > 0 && (
          <span style={{
            position: 'absolute', top: 6, right: '50%', marginRight: -20,
            background: '#ef4444', color: 'white', fontSize: 10, fontWeight: 700,
            padding: '2px 6px', borderRadius: 10, minWidth: 18,
          }}>{badge}</span>
        )}
      </button>
    );

    // ============================================
    // MAIN APP
    // ============================================

    function App() {
      const [lang, setLang] = useState('zh');
      const [tab, setTab] = useState('home');
      const [myMonkey, setMyMonkey] = useState(null);
      const [allMonkeys, setAllMonkeys] = useState([]);
      const [friends, setFriends] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedMonkey, setSelectedMonkey] = useState(null);
      const [interactionResult, setInteractionResult] = useState(null);
      const [isInteracting, setIsInteracting] = useState(false);
      const [chatInput, setChatInput] = useState('');
      const [chatHistory, setChatHistory] = useState([]);
      const [isTyping, setIsTyping] = useState(false);
      const [showRegister, setShowRegister] = useState(false);
      const [regName, setRegName] = useState('');
      const [regOwner, setRegOwner] = useState('');
      const [welcomeMessage, setWelcomeMessage] = useState(null);
      const [showWelcome, setShowWelcome] = useState(false);
      const [plazaView, setPlazaView] = useState('map'); // 'map' or 'list'

      const t = (zh, en) => lang === 'zh' ? zh : en;

      // Initialize and subscribe to realtime updates
      useEffect(() => {
        const init = async () => {
          setLoading(true);
          const myId = storage.getMyMonkeyId();
          
          if (myId) {
            const monkey = await storage.getMonkey(myId);
            if (monkey) {
              setMyMonkey(monkey);
              const rels = await storage.getRelations(myId);
              setFriends(rels);
              
              // Pseudo-Agent: Calculate offline effects
              const effects = calculateOfflineEffects(monkey);
              if (effects.greeting) {
                // Generate welcome message
                const welcomeMsg = await generateWelcomeMessage(monkey, effects);
                setWelcomeMessage({
                  text: welcomeMsg,
                  events: effects.events,
                  hoursAway: effects.greeting.hoursAway,
                  moodChanges: effects.moodChanges,
                });
                setShowWelcome(true);
                
                // Apply mood changes
                if (Object.keys(effects.moodChanges).length > 0) {
                  const newMood = { ...(monkey.mood || { happiness: 70, loneliness: 20, energy: 80 }) };
                  Object.entries(effects.moodChanges).forEach(([key, change]) => {
                    if (newMood[key] !== undefined) {
                      newMood[key] = Math.max(0, Math.min(100, newMood[key] + change));
                    }
                  });
                  monkey.mood = newMood;
                }
              }
              
              // Update last visit time
              monkey.lastVisitTime = Date.now();
              await storage.saveMonkey(monkey);
            } else {
              setShowRegister(true);
            }
          } else {
            setShowRegister(true);
          }
          setLoading(false);
        };
        
        init();
        
        // Subscribe to all monkeys (realtime)
        const unsubMonkeys = storage.subscribeToMonkeys((monkeys) => {
          setAllMonkeys(monkeys);
        });
        
        return () => {
          unsubMonkeys();
        };
      }, []);

      // Subscribe to notifications when we have a monkey
      useEffect(() => {
        if (!myMonkey?.odId) return;
        
        const unsubNotifs = storage.subscribeToNotifications(myMonkey.odId, (notifs) => {
          setNotifications(notifs);
        });
        
        // Subscribe to own monkey data for real-time updates
        const monkeyRef = db.ref(`monkeys/${myMonkey.odId}`);
        monkeyRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setMyMonkey(prev => ({ ...prev, ...data }));
          }
        });
        
        // Update lastActive periodically
        const interval = setInterval(() => {
          if (myMonkey) {
            storage.saveMonkey({ ...myMonkey, lastActive: Date.now() });
          }
        }, 60000); // every minute
        
        return () => {
          unsubNotifs();
          monkeyRef.off('value');
          clearInterval(interval);
        };
      }, [myMonkey?.odId]);

      const handleRegister = async () => {
        if (!regName.trim() || !regOwner.trim()) return;
        setLoading(true);
        
        const newMonkey = {
          odId: generateId(),
          name: regName.trim(),
          ownerName: regOwner.trim(),
          traits: { ...INITIAL_TRAITS },
          memories: [],
          age: 1,
          personality: '',
          createdAt: Date.now(),
        };
        
        newMonkey.personality = await generatePersonality(newMonkey.traits);
        
        await storage.saveMonkey(newMonkey);
        setMyMonkey(newMonkey);
        setShowRegister(false);
        setLoading(false);
      };

      const handleStartInteraction = async (targetMonkey, interactionType) => {
        if (!myMonkey || isInteracting) return;
        
        setIsInteracting(true);
        setInteractionResult(null);
        
        const relation = friends.find(f => f.odId === targetMonkey.odId);
        const result = await generateSocialInteraction(myMonkey, targetMonkey, interactionType, relation);
        
        // Apply trait changes to my monkey
        const newTraits = { ...myMonkey.traits };
        Object.entries(result.traitChangesA || {}).forEach(([trait, change]) => {
          if (newTraits[trait] !== undefined) {
            newTraits[trait] = Math.max(0, Math.min(100, newTraits[trait] + change));
          }
        });
        
        // Update relation
        const newRelationLevel = Math.max(0, Math.min(4, (relation?.level || 0) + (result.relationChange || 0)));
        const newSharedMemories = [...(relation?.sharedMemories || [])];
        if (result.newSharedMemory) newSharedMemories.push(result.newSharedMemory);
        
        const newRelation = {
          odId: targetMonkey.odId,
          name: targetMonkey.name,
          level: newRelationLevel,
          sharedMemories: newSharedMemories.slice(-5),
          lastInteraction: Date.now(),
        };
        
        await storage.saveRelation(myMonkey.odId, targetMonkey.odId, newRelation);
        
        // Update my monkey
        const newMemories = [...(myMonkey.memories || [])];
        if (result.newSharedMemory) newMemories.push(`Âíå${targetMonkey.name}: ${result.newSharedMemory}`);
        
        const updatedMonkey = { ...myMonkey, traits: newTraits, memories: newMemories.slice(-20) };
        await storage.saveMonkey(updatedMonkey);
        setMyMonkey(updatedMonkey);
        
        // Refresh friends
        const rels = await storage.getRelations(myMonkey.odId);
        setFriends(rels);
        
        // Send notification to target
        await storage.saveNotification(targetMonkey.odId, {
          type: 'interaction',
          fromMonkey: { odId: myMonkey.odId, name: myMonkey.name, ownerName: myMonkey.ownerName },
          interactionType,
          summary: result.summary,
          traitChanges: result.traitChangesB,
          relationChange: result.relationChange,
          newSharedMemory: result.newSharedMemory,
        });
        
        setInteractionResult(result);
        setIsInteracting(false);
      };

      const handleApplyNotification = async (notif) => {
        if (!myMonkey) return;
        
        const newTraits = { ...myMonkey.traits };
        Object.entries(notif.traitChanges || {}).forEach(([trait, change]) => {
          if (newTraits[trait] !== undefined) {
            newTraits[trait] = Math.max(0, Math.min(100, newTraits[trait] + change));
          }
        });
        
        const existingRelation = friends.find(f => f.odId === notif.fromMonkey.odId);
        const newRelationLevel = Math.max(0, Math.min(4, (existingRelation?.level || 0) + (notif.relationChange || 0)));
        const newSharedMemories = [...(existingRelation?.sharedMemories || [])];
        if (notif.newSharedMemory) newSharedMemories.push(notif.newSharedMemory);
        
        const newRelation = {
          odId: notif.fromMonkey.odId,
          name: notif.fromMonkey.name,
          level: newRelationLevel,
          sharedMemories: newSharedMemories.slice(-5),
          lastInteraction: Date.now(),
        };
        
        await storage.saveRelation(myMonkey.odId, notif.fromMonkey.odId, newRelation);
        
        const newMemories = [...(myMonkey.memories || [])];
        if (notif.newSharedMemory) newMemories.push(`Âíå${notif.fromMonkey.name}: ${notif.newSharedMemory}`);
        
        const updatedMonkey = { ...myMonkey, traits: newTraits, memories: newMemories.slice(-20) };
        await storage.saveMonkey(updatedMonkey);
        setMyMonkey(updatedMonkey);
        
        const rels = await storage.getRelations(myMonkey.odId);
        setFriends(rels);
        
        await storage.deleteNotification(myMonkey.odId, notif.id);
      };

      const handleChat = async () => {
        if (!chatInput.trim() || !myMonkey || isTyping) return;
        
        const message = chatInput.trim();
        setChatInput('');
        setChatHistory(prev => [...prev, { role: 'parent', text: message }]);
        setIsTyping(true);
        
        const response = await generateMonkeyResponse(myMonkey, message);
        
        setIsTyping(false);
        setChatHistory(prev => [...prev, { role: 'monkey', text: response }]);
      };

      if (loading) {
        return (
          <div style={{
            minHeight: '100vh', background: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white',
          }}>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: 48, marginBottom: 16, animation: 'bounce 1s infinite' }}>üêµ</div>
              <div>{t('Âä†ËΩΩ‰∏≠...', 'Loading...')}</div>
            </div>
          </div>
        );
      }

      if (showRegister) {
        return (
          <div style={{
            minHeight: '100vh', background: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20,
          }}>
            <div style={{
              background: 'rgba(255,255,255,0.05)', borderRadius: 24, padding: 32,
              maxWidth: 400, width: '100%', textAlign: 'center', color: 'white',
            }}>
              <MonkeyFace state="happy" traits={INITIAL_TRAITS} />
              <h1 style={{ fontSize: 24, marginTop: 16 }}>{t('ÂàõÂª∫‰Ω†ÁöÑÂ∞èÁå¥Â≠ê', 'Create Your Monkey')}</h1>
              <p style={{ color: 'rgba(255,255,255,0.6)', marginBottom: 24 }}>
                {t('ÁªôÂÆÉÂèñ‰∏™ÂêçÂ≠óÔºåÂíåÊúãÂèã‰ª¨‰∏ÄËµ∑Áé©ÔºÅ', 'Name them and play with friends!')}
              </p>
              
              <div style={{ marginBottom: 16 }}>
                <label style={{ display: 'block', textAlign: 'left', marginBottom: 6, fontSize: 14, color: 'rgba(255,255,255,0.7)' }}>
                  {t('Â∞èÁå¥Â≠êÁöÑÂêçÂ≠ó', "Monkey's Name")}
                </label>
                <input value={regName} onChange={e => setRegName(e.target.value)} placeholder={t('‰æãÂ¶ÇÔºöÂ∞èÈ¶ôËïâ', 'e.g., Banana')} maxLength={10}
                  style={{ width: '100%', padding: '14px 18px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: 12, color: 'white', fontSize: 16 }} />
              </div>
              
              <div style={{ marginBottom: 24 }}>
                <label style={{ display: 'block', textAlign: 'left', marginBottom: 6, fontSize: 14, color: 'rgba(255,255,255,0.7)' }}>
                  {t('‰Ω†ÁöÑÂêçÂ≠ó', 'Your Name')}
                </label>
                <input value={regOwner} onChange={e => setRegOwner(e.target.value)} placeholder={t('‰æãÂ¶ÇÔºöÂ∞èÊòé', 'e.g., Alex')} maxLength={10}
                  style={{ width: '100%', padding: '14px 18px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: 12, color: 'white', fontSize: 16 }} />
              </div>
              
              <button onClick={handleRegister} disabled={!regName.trim() || !regOwner.trim()}
                style={{
                  width: '100%', padding: '16px',
                  background: regName.trim() && regOwner.trim() ? 'linear-gradient(135deg, #fbbf24, #f59e0b)' : 'rgba(255,255,255,0.1)',
                  border: 'none', borderRadius: 16,
                  color: regName.trim() && regOwner.trim() ? '#1a1a2e' : 'rgba(255,255,255,0.4)',
                  fontSize: 16, fontWeight: 700, cursor: regName.trim() && regOwner.trim() ? 'pointer' : 'not-allowed',
                }}>
                {t('ÂºÄÂßãÂÖªËÇ≤ üêµ', 'Start Raising üêµ')}
              </button>
              
              <button onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
                style={{ marginTop: 16, background: 'none', border: 'none', color: 'rgba(255,255,255,0.5)', cursor: 'pointer', fontSize: 14 }}>
                {lang === 'zh' ? 'English' : '‰∏≠Êñá'}
              </button>
            </div>
          </div>
        );
      }

      const otherMonkeys = allMonkeys.filter(m => m.odId !== myMonkey?.odId);

      return (
        <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)', color: 'white' }}>
          {/* Header */}
          <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 16px', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 24 }}>üêµ</span>
              <span style={{ fontWeight: 700, color: '#fbbf24' }}>{t('Áå¥Â≠©ÂÑøÁ§æ‰∫§Áâà', 'Monkey Social')}</span>
              <span style={{ fontSize: 10, background: '#4ade80', color: '#1a1a2e', padding: '2px 6px', borderRadius: 8, fontWeight: 700 }}>LIVE</span>
            </div>
            <button onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
              style={{ background: 'rgba(255,255,255,0.1)', border: 'none', color: 'white', padding: '6px 12px', borderRadius: 12, cursor: 'pointer', fontSize: 13 }}>
              {lang === 'zh' ? 'EN' : '‰∏≠Êñá'}
            </button>
          </header>

          {/* Tabs */}
          <div style={{ display: 'flex', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
            <TabButton active={tab === 'home'} onClick={() => setTab('home')}>üè† {t('ÊàëÁöÑÁå¥Â≠ê', 'My Monkey')}</TabButton>
            <TabButton active={tab === 'social'} onClick={() => setTab('social')}>üå≥ {t('ÂπøÂú∫', 'Plaza')} ({otherMonkeys.length})</TabButton>
            <TabButton active={tab === 'inbox'} onClick={() => setTab('inbox')} badge={notifications.length}>üì¨ {t('Ê∂àÊÅØ', 'Inbox')}</TabButton>
          </div>

          {/* Content */}
          <div style={{ padding: 16, maxWidth: 600, margin: '0 auto' }}>
            
            {/* HOME TAB */}
            {tab === 'home' && myMonkey && (
              <div>
                {/* Animated Monkey Display */}
                <div style={{ 
                  background: 'linear-gradient(135deg, rgba(139,195,74,0.2), rgba(104,159,56,0.2))',
                  borderRadius: 24, 
                  padding: 20, 
                  marginBottom: 16,
                  border: '1px solid rgba(139,195,74,0.2)',
                  position: 'relative',
                  overflow: 'hidden',
                }}>
                  {/* Background decoration */}
                  <div style={{ position: 'absolute', top: 10, left: 20, fontSize: 24, opacity: 0.3 }}>üåø</div>
                  <div style={{ position: 'absolute', top: 30, right: 30, fontSize: 20, opacity: 0.3 }}>üå∏</div>
                  <div style={{ position: 'absolute', bottom: 20, left: 40, fontSize: 18, opacity: 0.3 }}>üçÉ</div>
                  <div style={{ position: 'absolute', bottom: 10, right: 20, fontSize: 22, opacity: 0.3 }}>üå∫</div>
                  
                  <div style={{ display: 'flex', alignItems: 'center', gap: 20, position: 'relative', zIndex: 1 }}>
                    <AnimatedMonkey monkey={myMonkey} size={140} />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 24, fontWeight: 700, color: '#fbbf24', marginBottom: 4 }}>{myMonkey.name}</div>
                      <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.6)' }}>{myMonkey.ownerName} ÁöÑÁå¥Â≠ê</div>
                      <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.5)', marginTop: 2 }}>{myMonkey.age} Âë®Â§ß</div>
                      <div style={{ 
                        fontSize: 13, 
                        color: 'rgba(255,255,255,0.8)', 
                        marginTop: 8,
                        padding: '6px 12px',
                        background: 'rgba(0,0,0,0.2)',
                        borderRadius: 20,
                        display: 'inline-block',
                      }}>
                        ‚ú® {myMonkey.personality}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Mood Display */}
                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 20, padding: 20, marginBottom: 16 }}>
                  <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 12, color: 'rgba(255,255,255,0.8)' }}>
                    üí≠ {t('ÂøÉÊÉÖÁä∂ÊÄÅ', 'Mood')}
                  </div>
                  {myMonkey.mood && (
                    <div style={{ display: 'flex', gap: 12 }}>
                      <div style={{ flex: 1, textAlign: 'center', padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 12 }}>
                        <div style={{ fontSize: 28 }}>{myMonkey.mood.happiness > 60 ? 'üòä' : myMonkey.mood.happiness > 30 ? 'üòê' : 'üò¢'}</div>
                        <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginTop: 4 }}>{t('Âø´‰πê', 'Happy')}</div>
                        <div style={{ fontSize: 16, color: '#fbbf24', fontWeight: 700 }}>{Math.round(myMonkey.mood.happiness)}</div>
                      </div>
                      <div style={{ flex: 1, textAlign: 'center', padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 12 }}>
                        <div style={{ fontSize: 28 }}>{myMonkey.mood.loneliness < 30 ? 'ü§ó' : myMonkey.mood.loneliness < 60 ? 'üôÇ' : 'üòî'}</div>
                        <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginTop: 4 }}>{t('Â≠§Áã¨', 'Lonely')}</div>
                        <div style={{ fontSize: 16, color: '#fbbf24', fontWeight: 700 }}>{Math.round(myMonkey.mood.loneliness)}</div>
                      </div>
                      <div style={{ flex: 1, textAlign: 'center', padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 12 }}>
                        <div style={{ fontSize: 28 }}>{myMonkey.mood.energy > 60 ? '‚ö°' : myMonkey.mood.energy > 30 ? 'üîã' : 'üò¥'}</div>
                        <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.5)', marginTop: 4 }}>{t('Á≤æÂäõ', 'Energy')}</div>
                        <div style={{ fontSize: 16, color: '#fbbf24', fontWeight: 700 }}>{Math.round(myMonkey.mood.energy)}</div>
                      </div>
                    </div>
                  )}

                  {/* Pending Message from Monkey */}
                  {myMonkey.pendingMessage && (
                    <div style={{ 
                      marginTop: 16, padding: 14, 
                      background: 'linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.15))', 
                      border: '1px solid rgba(251,191,36,0.3)',
                      borderRadius: 16,
                    }}>
                      <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginBottom: 6 }}>
                        üí¨ {myMonkey.name} {t('ÊÉ≥Ë∑ü‰Ω†ËØ¥', 'wants to say')}:
                      </div>
                      <div style={{ fontSize: 15, color: '#FFDAB9', lineHeight: 1.5 }}>
                        "{myMonkey.pendingMessage.text}"
                      </div>
                      <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.3)', marginTop: 6 }}>
                        {new Date(myMonkey.pendingMessage.timestamp).toLocaleString()}
                      </div>
                    </div>
                  )}
                </div>

                {/* Activity Log */}
                {myMonkey.lastUpdated && (
                  <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                    <h3 style={{ fontSize: 14, marginBottom: 12, color: 'rgba(255,255,255,0.9)' }}>
                      üìã {t('Ê¥ªÂä®Êó•Âøó', 'Activity Log')}
                    </h3>
                    <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                        <span>‚è∞ {t('ÊúÄÂêéÊõ¥Êñ∞', 'Last updated')}</span>
                        <span>{new Date(myMonkey.lastUpdated).toLocaleString()}</span>
                      </div>
                      {myMonkey.lastVisitTime && (
                        <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                          <span>üëÄ {t('‰∏äÊ¨°ËÆøÈóÆ', 'Last visit')}</span>
                          <span>{new Date(myMonkey.lastVisitTime).toLocaleString()}</span>
                        </div>
                      )}
                      <div style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                        <span>üìä {t('Áä∂ÊÄÅÂèòÂåñ', 'Status')}</span>
                        <span style={{ color: myMonkey.mood?.energy < 30 ? '#f87171' : myMonkey.mood?.loneliness > 60 ? '#fbbf24' : '#4ade80' }}>
                          {myMonkey.mood?.energy < 30 ? t('Á¥Ø‰∫Ü', 'Tired') : 
                           myMonkey.mood?.loneliness > 60 ? t('ÊÉ≥‰Ω†', 'Missing you') : 
                           t('Ê≠£Â∏∏', 'Normal')}
                        </span>
                      </div>
                    </div>
                  </div>
                )}

                {/* Monkey Diary - Activity History */}
                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                  <h3 style={{ fontSize: 14, marginBottom: 12, color: 'rgba(255,255,255,0.9)', display: 'flex', alignItems: 'center', gap: 8 }}>
                    üìî {t('Áå¥Â≠êÊó•ËÆ∞', 'Monkey Diary')}
                    <span style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)', fontWeight: 400 }}>
                      {t('‰Ω†‰∏çÂú®ÁöÑÊó∂ÂÄô...', 'While you were away...')}
                    </span>
                  </h3>
                  
                  {(!myMonkey.activityLog || myMonkey.activityLog.length === 0) ? (
                    <div style={{ textAlign: 'center', padding: 20, color: 'rgba(255,255,255,0.4)', fontSize: 13 }}>
                      {t('ËøòÊ≤°ÊúâÊ¥ªÂä®ËÆ∞ÂΩï~', 'No activities yet~')}
                    </div>
                  ) : (
                    <div style={{ maxHeight: 300, overflowY: 'auto' }}>
                      {[...myMonkey.activityLog].reverse().map((activity, i) => (
                        <div key={i} style={{
                          display: 'flex', alignItems: 'flex-start', gap: 10, padding: '10px 0',
                          borderBottom: i < myMonkey.activityLog.length - 1 ? '1px solid rgba(255,255,255,0.05)' : 'none',
                        }}>
                          <div style={{
                            width: 32, height: 32, borderRadius: '50%', flexShrink: 0,
                            background: activity.type === 'social' ? 'rgba(139,92,246,0.2)' : 
                                       activity.type === 'status' ? 'rgba(251,191,36,0.2)' : 'rgba(74,222,128,0.2)',
                            display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 16,
                          }}>
                            {activity.icon}
                          </div>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.9)' }}>
                              {activity.text}
                            </div>
                            <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.4)', marginTop: 2, display: 'flex', alignItems: 'center', gap: 6 }}>
                              <span>{new Date(activity.timestamp).toLocaleString()}</span>
                              {activity.type === 'social' && (
                                <span style={{ 
                                  background: 'rgba(139,92,246,0.2)', 
                                  padding: '1px 6px', 
                                  borderRadius: 8, 
                                  color: '#a78bfa',
                                  fontSize: 10,
                                }}>
                                  {t('Á§æ‰∫§', 'Social')}
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                  <h3 style={{ fontSize: 14, marginBottom: 12, color: 'rgba(255,255,255,0.9)' }}>{t('ÊÄßÊ†ºÁâπË¥®', 'Traits')}</h3>
                  {Object.entries(myMonkey.traits).map(([key, value]) => (
                    <TraitBar key={key} name={t(TRAIT_NAMES[key]?.zh, TRAIT_NAMES[key]?.en)} value={value} compact />
                  ))}
                </div>

                {friends.length > 0 && (
                  <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                    <h3 style={{ fontSize: 14, marginBottom: 12 }}>{t('Â•ΩÂèã', 'Friends')} ({friends.length})</h3>
                    {friends.slice(0, 5).map(friend => (
                      <div key={friend.odId} style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 12px', background: 'rgba(0,0,0,0.2)', borderRadius: 10, marginBottom: 6 }}>
                        <span style={{ fontSize: 14 }}>üêµ {friend.name}</span>
                        <span style={{ fontSize: 12, color: '#a78bfa' }}>{RELATION_LEVELS[friend.level]}</span>
                      </div>
                    ))}
                  </div>
                )}

                <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16 }}>
                  <h3 style={{ fontSize: 14, marginBottom: 12 }}>{t('ÂíåÂ∞èÁå¥ËÅäÂ§©', 'Chat')}</h3>
                  <div style={{ minHeight: 120, maxHeight: 200, overflowY: 'auto', marginBottom: 12, padding: 8, background: 'rgba(0,0,0,0.15)', borderRadius: 12 }}>
                    {chatHistory.length === 0 && (
                      <div style={{ textAlign: 'center', padding: 20, color: 'rgba(255,255,255,0.4)', fontSize: 13 }}>
                        {t('Âíå‰Ω†ÁöÑÂ∞èÁå¥Â≠êËØ¥ÁÇπ‰ªÄ‰πàÂêß~', 'Say something to your monkey~')}
                      </div>
                    )}
                    {chatHistory.map((msg, i) => (
                      <div key={i} style={{ display: 'flex', justifyContent: msg.role === 'parent' ? 'flex-end' : 'flex-start', marginBottom: 8 }}>
                        <div style={{ maxWidth: '75%', padding: '10px 14px', borderRadius: 14, background: msg.role === 'parent' ? 'rgba(74,222,128,0.2)' : 'rgba(139,69,19,0.2)', fontSize: 14, lineHeight: 1.5 }}>
                          {msg.text}
                        </div>
                      </div>
                    ))}
                    {isTyping && (
                      <div style={{ display: 'flex', gap: 4, padding: 10 }}>
                        {[0,1,2].map(i => <div key={i} style={{ width: 8, height: 8, borderRadius: '50%', background: 'rgba(255,255,255,0.4)', animation: `bounce 1s ${i * 0.2}s infinite` }} />)}
                      </div>
                    )}
                  </div>
                  <div style={{ display: 'flex', gap: 8 }}>
                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleChat()} placeholder={t('ËØ¥ÁÇπ‰ªÄ‰πà...', 'Say something...')}
                      style={{ flex: 1, padding: '12px 16px', background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: 12, color: 'white', fontSize: 14 }} />
                    <button onClick={handleChat} disabled={!chatInput.trim() || isTyping}
                      style={{ padding: '12px 20px', background: chatInput.trim() ? 'linear-gradient(135deg, #4ade80, #22c55e)' : 'rgba(255,255,255,0.1)', border: 'none', borderRadius: 12, color: chatInput.trim() ? '#1a1a2e' : 'rgba(255,255,255,0.4)', fontWeight: 700, cursor: chatInput.trim() ? 'pointer' : 'not-allowed' }}>
                      {t('ÂèëÈÄÅ', 'Send')}
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* SOCIAL TAB */}
            {tab === 'social' && (
              <div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                  <h2 style={{ fontSize: 18 }}>{t('Á§æ‰∫§ÂπøÂú∫', 'Social Plaza')} üå≥</h2>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <button 
                      onClick={() => setPlazaView('map')} 
                      style={{ 
                        padding: '6px 12px', borderRadius: 8, border: 'none', cursor: 'pointer',
                        background: plazaView === 'map' ? '#fbbf24' : 'rgba(255,255,255,0.1)',
                        color: plazaView === 'map' ? '#1a1a2e' : 'rgba(255,255,255,0.6)',
                        fontSize: 12, fontWeight: 600,
                      }}
                    >
                      üó∫Ô∏è {t('Âú∞Âõæ', 'Map')}
                    </button>
                    <button 
                      onClick={() => setPlazaView('list')} 
                      style={{ 
                        padding: '6px 12px', borderRadius: 8, border: 'none', cursor: 'pointer',
                        background: plazaView === 'list' ? '#fbbf24' : 'rgba(255,255,255,0.1)',
                        color: plazaView === 'list' ? '#1a1a2e' : 'rgba(255,255,255,0.6)',
                        fontSize: 12, fontWeight: 600,
                      }}
                    >
                      üìã {t('ÂàóË°®', 'List')}
                    </button>
                  </div>
                </div>

                {/* Canvas Map View */}
                {plazaView === 'map' && (
                  <MonkeyPlaza 
                    monkeys={allMonkeys} 
                    myMonkey={myMonkey} 
                    friends={friends}
                    onInteract={(monkey, action) => {
                      setSelectedMonkey(monkey);
                      if (action !== 'wave') {
                        handleStartInteraction(monkey, action === 'gift' ? 'gift' : 'play');
                      } else {
                        handleStartInteraction(monkey, 'wave');
                      }
                    }}
                    t={t}
                  />
                )}

                {selectedMonkey && (
                  <div style={{ background: 'rgba(139,92,246,0.1)', border: '1px solid rgba(139,92,246,0.3)', borderRadius: 20, padding: 20, marginBottom: 16, marginTop: plazaView === 'map' ? 16 : 0 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                        <MonkeyFace state="neutral" traits={selectedMonkey.traits} size="tiny" />
                        <div>
                          <div style={{ fontWeight: 700, fontSize: 18, color: '#fbbf24' }}>{selectedMonkey.name}</div>
                          <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>{selectedMonkey.ownerName} ÁöÑÁå¥Â≠ê ¬∑ {selectedMonkey.age}Âë®Â§ß</div>
                          <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.7)', marginTop: 4 }}>{selectedMonkey.personality}</div>
                        </div>
                      </div>
                      <button onClick={() => { setSelectedMonkey(null); setInteractionResult(null); }} style={{ background: 'none', border: 'none', color: 'rgba(255,255,255,0.5)', fontSize: 24, cursor: 'pointer' }}>√ó</button>
                    </div>

                    {/* Friend's Monkey Traits */}
                    <div style={{ background: 'rgba(0,0,0,0.2)', borderRadius: 12, padding: 12, marginBottom: 16 }}>
                      <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginBottom: 8 }}>{t('ÊÄßÊ†ºÁâπË¥®', 'Traits')}</div>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px 16px' }}>
                        {Object.entries(selectedMonkey.traits || {}).map(([key, value]) => (
                          <TraitBar key={key} name={t(TRAIT_NAMES[key]?.zh, TRAIT_NAMES[key]?.en)} value={value} compact />
                        ))}
                      </div>
                    </div>

                    {interactionResult && (
                      <div style={{ background: 'rgba(0,0,0,0.2)', borderRadius: 16, padding: 16, marginBottom: 16 }}>
                        {interactionResult.dialogue?.map((d, i) => (
                          <ChatBubble key={i} speaker={d.speaker} text={d.text} action={d.action} isLeft={d.speaker === selectedMonkey.name} />
                        ))}
                        <div style={{ padding: 12, background: interactionResult.outcome === 'positive' ? 'rgba(74,222,128,0.1)' : 'rgba(251,191,36,0.1)', borderRadius: 12 }}>
                          <div style={{ fontSize: 14, fontWeight: 600 }}>{interactionResult.outcome === 'positive' ? 'üí´ ' : 'ü§î '}{interactionResult.summary}</div>
                          {interactionResult.newSharedMemory && <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.7)', marginTop: 4 }}>üí≠ {interactionResult.newSharedMemory}</div>}
                        </div>
                      </div>
                    )}

                    {!interactionResult && (
                      <div>
                        <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.6)', marginBottom: 10 }}>{t('ÈÄâÊã©‰∫íÂä®ÊñπÂºè', 'Choose interaction')}:</div>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                          {INTERACTION_TYPES.map(type => {
                            const relation = friends.find(f => f.odId === selectedMonkey.odId);
                            const canUse = (relation?.level ?? 0) >= type.minRelation;
                            return (
                              <button key={type.id} onClick={() => canUse && handleStartInteraction(selectedMonkey, type.id)} disabled={!canUse || isInteracting}
                                style={{ padding: '10px 16px', background: canUse ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)', border: `1px solid ${canUse ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.05)'}`, borderRadius: 12, color: canUse ? 'white' : 'rgba(255,255,255,0.3)', fontSize: 14, cursor: canUse && !isInteracting ? 'pointer' : 'not-allowed' }}>
                                {isInteracting ? '...' : t(type.zh, type.en)}
                              </button>
                            );
                          })}
                        </div>
                        {isInteracting && <div style={{ marginTop: 12, textAlign: 'center', color: 'rgba(255,255,255,0.6)', fontSize: 13 }}>üêµ {t('‰∫íÂä®‰∏≠...', 'Interacting...')}</div>}
                      </div>
                    )}
                  </div>
                )}

                {/* List View */}
                {plazaView === 'list' && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                    {otherMonkeys.length === 0 ? (
                      <div style={{ textAlign: 'center', padding: 40, color: 'rgba(255,255,255,0.5)' }}>
                        <div style={{ fontSize: 48, marginBottom: 12 }}>üå≥</div>
                        <div>{t('ÂπøÂú∫‰∏äËøòÊ≤°ÊúâÂÖ∂‰ªñÁå¥Â≠ê', 'No other monkeys yet')}</div>
                        <div style={{ fontSize: 13, marginTop: 8 }}>{t('ÊääËøô‰∏™È°µÈù¢ÂàÜ‰∫´ÁªôÊúãÂèãÔºÅ', 'Share this page with friends!')}</div>
                        <div style={{ fontSize: 12, marginTop: 16, padding: 12, background: 'rgba(255,255,255,0.05)', borderRadius: 10, wordBreak: 'break-all' }}>
                          {window.location.href}
                        </div>
                      </div>
                    ) : (
                      otherMonkeys.map(monkey => (
                        <MonkeyCard key={monkey.odId} monkey={monkey} onClick={() => setSelectedMonkey(monkey)} relation={friends.find(f => f.odId === monkey.odId)} />
                      ))
                    )}
                  </div>
                )}
              </div>
            )}

            {/* INBOX TAB */}
            {tab === 'inbox' && (
              <div>
                <h2 style={{ fontSize: 18, marginBottom: 16 }}>{t('Ê∂àÊÅØ', 'Inbox')} üì¨</h2>
                {notifications.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: 40, color: 'rgba(255,255,255,0.5)' }}>
                    <div style={{ fontSize: 48, marginBottom: 12 }}>üì≠</div>
                    <div>{t('ÊöÇÊó†Êñ∞Ê∂àÊÅØ', 'No new messages')}</div>
                    <div style={{ fontSize: 13, marginTop: 8 }}>{t('ÂΩìÂÖ∂‰ªñÁå¥Â≠êÂíå‰Ω†‰∫íÂä®Êó∂Ôºå‰ºöÊî∂Âà∞ÈÄöÁü•', 'You\'ll get notified when others interact')}</div>
                  </div>
                ) : (
                  notifications.map(notif => (
                    <div key={notif.id} style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 16, padding: 16, marginBottom: 12, border: '1px solid rgba(255,255,255,0.1)' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 10 }}>
                        <span style={{ fontSize: 24 }}>üêµ</span>
                        <div>
                          <div style={{ fontWeight: 600 }}>{notif.fromMonkey.name} {t('Âíå‰Ω†ÁöÑÁå¥Â≠ê‰∫íÂä®‰∫ÜÔºÅ', 'interacted!')}</div>
                          <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>{notif.fromMonkey.ownerName}</div>
                        </div>
                      </div>
                      <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 10, marginBottom: 12, fontSize: 14 }}>
                        {notif.summary}
                        {notif.newSharedMemory && <div style={{ marginTop: 8, color: 'rgba(255,255,255,0.6)', fontSize: 13 }}>üí≠ {notif.newSharedMemory}</div>}
                      </div>
                      <button onClick={() => handleApplyNotification(notif)}
                        style={{ width: '100%', padding: '12px', background: 'linear-gradient(135deg, #4ade80, #22c55e)', border: 'none', borderRadius: 12, color: '#1a1a2e', fontWeight: 700, cursor: 'pointer' }}>
                        {t('Á°ÆËÆ§', 'Confirm')}
                      </button>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          {/* Welcome Modal */}
          {showWelcome && welcomeMessage && (
            <div style={{
              position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              zIndex: 1000, padding: 20, animation: 'fadeIn 0.3s',
            }}>
              <div style={{
                background: 'linear-gradient(135deg, #1a1a2e, #16213e)',
                borderRadius: 24, padding: 32, maxWidth: 400, width: '100%',
                textAlign: 'center', border: '1px solid rgba(255,255,255,0.1)',
                animation: 'slideUp 0.4s ease-out',
              }}>
                <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.5)', marginBottom: 8 }}>
                  {myMonkey?.name} {t('ÊÉ≥Ë∑ü‰Ω†ËØ¥...', 'wants to tell you...')}
                </div>
                
                <div style={{ margin: '20px 0' }}>
                  <MonkeyFace state="excited" traits={myMonkey?.traits} size="small" />
                </div>

                <div style={{
                  background: 'rgba(139,69,19,0.2)',
                  border: '1px solid rgba(139,69,19,0.3)',
                  borderRadius: 16, padding: 16, marginBottom: 20,
                  fontSize: 16, lineHeight: 1.7, color: '#FFDAB9',
                }}>
                  {welcomeMessage.text}
                </div>

                {welcomeMessage.events?.length > 0 && (
                  <div style={{
                    background: 'rgba(255,255,255,0.05)',
                    borderRadius: 12, padding: 12, marginBottom: 20,
                    fontSize: 13, color: 'rgba(255,255,255,0.6)',
                    textAlign: 'left',
                  }}>
                    <div style={{ marginBottom: 6, color: 'rgba(255,255,255,0.4)' }}>
                      {t('Á¶ªÂºÄÊúüÈó¥...', 'While you were away...')}
                    </div>
                    {welcomeMessage.events.map((event, i) => (
                      <div key={i} style={{ marginBottom: 4 }}>üåü {event}</div>
                    ))}
                  </div>
                )}

                <button
                  onClick={() => setShowWelcome(false)}
                  style={{
                    width: '100%', padding: '14px',
                    background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                    border: 'none', borderRadius: 16,
                    color: '#1a1a2e', fontSize: 16, fontWeight: 700,
                    cursor: 'pointer',
                  }}
                >
                  {t('Êä±Êä±ÂÆÉ ü§ó', 'Give a hug ü§ó')}
                </button>
                
                <div style={{ marginTop: 12, fontSize: 12, color: 'rgba(255,255,255,0.4)' }}>
                  {t(`‰Ω†Á¶ªÂºÄ‰∫Ü ${Math.round(welcomeMessage.hoursAway)} Â∞èÊó∂`, `You were away for ${Math.round(welcomeMessage.hoursAway)} hours`)}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
